<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Sovereign | Eternal Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        /* --- DESIGN SYSTEM & VARIABLES --- */
        :root { 
            --accent: #00d2ff; 
            --accent-glow: rgba(0, 210, 255, 0.4);
            --bg: #03030b; 
            --panel: rgba(10, 10, 18, 0.98);
            --wa-sent: #005c4b; 
            --wa-received: #202c33; 
            --border: rgba(0, 210, 255, 0.15);
            --danger: #ff3b3b; 
            --online: #00ff88; 
            --away: #ffbb00; 
            --offline: #555;
            --text-main: #f0f0f0;
            --text-dim: #a0a0a0;
        }

        /* --- RESET & CORE STYLES --- */
        * { box-sizing: border-box; outline: none; }
        body, html { 
            margin: 0; padding: 0; 
            background: var(--bg); 
            color: var(--text-main); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden; 
        }

        /* --- BACKGROUND STAR ENGINE --- */
        #star-canvas { 
            position: fixed; inset: 0; z-index: 0; 
            pointer-events: none; background: radial-gradient(circle at center, #06061a 0%, #000 100%);
        }

        /* --- GLOBAL PROGRESS BAR --- */
        #progress-bar { 
            position: fixed; top: 0; left: 0; height: 3px; 
            background: linear-gradient(90deg, transparent, var(--accent), transparent); 
            width: 0%; transition: width 0.4s cubic-bezier(0.1, 0.7, 1.0, 0.1); 
            z-index: 5000; box-shadow: 0 0 10px var(--accent);
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 210, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0); } }

        /* --- AUTH GATE --- */
        #auth-gate { 
            position: fixed; inset: 0; z-index: 4000; 
            background: black; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
            text-align: center;
        }
        .gate-logo {
            font-size: 3rem; font-weight: 900; color: var(--accent);
            letter-spacing: 20px; text-shadow: 0 0 30px var(--accent);
            margin-bottom: 10px; animation: fadeIn 2s ease;
        }

        /* --- IDENTITY LOCK OVERLAY --- */
        #identity-lock { 
            position: fixed; inset: 0; z-index: 3000; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); 
            display: none; align-items: center; justify-content: center; padding: 20px; 
        }
        .lock-box { 
            background: #111b21; padding: 40px; border-radius: 30px; 
            border: 1px solid var(--border); max-width: 500px; width: 100%; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: slideUp 0.5s ease;
        }

        /* --- APP WRAPPER --- */
        .nexus-wrapper { 
            display: none; height: 100vh; width: 100vw; 
            position: relative; z-index: 10; flex-direction: row; 
            animation: fadeIn 1s ease;
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 400px; background: var(--panel); 
            border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; 
            z-index: 100; transition: transform 0.3s ease;
        }
        
        .sidebar-header { padding: 20px; background: #111b21; }
        .search-container { position: relative; width: 100%; }
        .search-input { 
            width: 100%; padding: 12px 20px 12px 45px; 
            border-radius: 25px; border: 1px solid #333; 
            background: #2a3942; color: #fff; font-size: 0.9rem;
        }
        .search-icon { position: absolute; left: 18px; top: 13px; opacity: 0.5; }

        #search-results { 
            position: absolute; top: 55px; left: 0; width: 100%; 
            background: #1c2a33; border-radius: 15px; border: 1px solid var(--accent);
            display: none; z-index: 500; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .tab-bar { display: flex; background: #111b21; border-bottom: 1px solid #222; }
        .tab-item { 
            flex: 1; padding: 18px; text-align: center; 
            font-size: 0.75rem; font-weight: bold; cursor: pointer;
            color: var(--text-dim); border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab-item.active { color: var(--accent); border-bottom-color: var(--accent); }

        .list-area { flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .chat-row { 
            padding: 15px 20px; border-bottom: 1px solid #1a1a1a; 
            cursor: pointer; display: flex; align-items: center; gap: 15px; 
            transition: 0.2s;
        }
        .chat-row:hover { background: rgba(255,255,255,0.03); }
        .avatar-circle { 
            width: 50px; height: 50px; border-radius: 50%; 
            background: #333; display: flex; align-items: center; 
            justify-content: center; font-weight: bold; color: var(--accent);
            border: 1px solid var(--border);
        }

        /* --- MAIN STAGE --- */
        .main-stage { 
            flex: 1; display: flex; flex-direction: column; 
            background: rgba(11, 20, 26, 0.9); position: relative;
        }
        
        .stage-header { 
            padding: 12px 25px; background: #202c33; 
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #333; height: 70px;
        }

        .message-viewport { 
            flex: 1; overflow-y: auto; padding: 30px; 
            display: flex; flex-direction: column; gap: 12px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat; background-attachment: fixed;
        }

        /* --- MESSAGE BUBBLES --- */
        .msg-bubble { 
            max-width: 65%; padding: 10px 15px; border-radius: 15px; 
            font-size: 0.95rem; line-height: 1.5; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); word-wrap: break-word;
        }
        .msg-sent { 
            align-self: flex-end; background: var(--wa-sent); 
            border-top-right-radius: 2px; color: #e9edef;
        }
        .msg-received { 
            align-self: flex-start; background: var(--wa-received); 
            border-top-left-radius: 2px; color: #e9edef;
        }
        .msg-image { 
            width: 100%; max-width: 300px; border-radius: 10px; 
            margin-bottom: 8px; cursor: pointer; display: block;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .msg-info { 
            font-size: 0.65rem; opacity: 0.6; margin-top: 5px; 
            text-align: right; font-weight: 600; 
        }

        /* --- INPUT BAR --- */
        .input-bar { 
            padding: 10px 20px; background: #202c33; 
            display: flex; align-items: center; gap: 15px;
        }
        .action-icon { cursor: pointer; font-size: 1.4rem; color: #8696a0; transition: 0.2s; }
        .action-icon:hover { color: var(--accent); }
        .main-input { 
            flex: 1; background: #2a3942; border: none; padding: 12px 20px; 
            border-radius: 25px; color: #fff; font-size: 0.95rem;
        }

        /* --- NEBULA FEED STYLES --- */
        .nebula-container { padding: 30px; display: none; overflow-y: auto; flex: 1; }
        .nebula-post { 
            background: #111b21; padding: 25px; border-radius: 20px; 
            border: 1px solid var(--border); margin-bottom: 25px;
            transition: 0.3s;
        }
        .nebula-post:hover { border-color: var(--accent); }
        .post-author { color: var(--accent); font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; }
        .post-title { font-size: 1.2rem; margin: 5px 0 10px 0; letter-spacing: 0.5px; }
        .post-body { opacity: 0.8; line-height: 1.6; font-size: 0.95rem; }

        /* --- STATUS DOTS --- */
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online { background: var(--online); box-shadow: 0 0 8px var(--online); }
        .away { background: var(--away); box-shadow: 0 0 8px var(--away); }
        .cloaked { background: var(--offline); }

        /* --- UI COMPONENTS --- */
        .btn-primary { 
            background: var(--accent); color: #000; font-weight: bold; 
            padding: 14px; border-radius: 50px; border: none; cursor: pointer;
            width: 100%; transition: 0.3s; margin-top: 15px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--accent-glow); }
        
        input[type="text"], textarea, select { 
            width: 100%; padding: 14px; background: #2a3942; 
            border: 1px solid #333; color: #fff; border-radius: 12px; margin-top: 10px;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 800px) {
            .sidebar { width: 100%; }
            .main-stage { 
                position: fixed; inset: 0; display: none; z-index: 1000;
            }
            .main-stage.active { display: flex; }
            #back-btn { display: block !important; }
        }
    </style>
</head>
<body>

<div id="progress-bar"></div>
<canvas id="star-canvas"></canvas>

<div id="auth-gate">
    <div class="gate-logo">NEXUS</div>
    <p style="color:var(--text-dim); margin-bottom:30px; letter-spacing:2px;">SOVEREIGN OMNIA PROTOCOL</p>
    <button class="btn-primary" style="width:250px;" onclick="handleLogin()">INITIALIZE SYNC</button>
</div>

<div id="identity-lock">
    <div class="lock-box">
        <h2 style="color:var(--accent); margin:0 0 10px 0;">PILOT CREDENTIALS</h2>
        <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:20px;">Identity setup is mandatory for neural-link sync.</p>
        
        <label style="font-size:0.7rem; color:var(--accent);">PILOT CALLSIGN</label>
        <input type="text" id="pilot-name" placeholder="e.g. Ghost_One">
        
        <label style="font-size:0.7rem; color:var(--accent); margin-top:15px; display:block;">STATUS FREQUENCY</label>
        <select id="pilot-status">
            <option value="online">üü¢ Active (Online)</option>
            <option value="away">üü° Deep Sleep (Away)</option>
            <option value="cloaked">‚ö™ Stealth Mode (Cloaked)</option>
        </select>
        
        <label style="font-size:0.7rem; color:var(--accent); margin-top:15px; display:block;">MISSION BIO</label>
        <textarea id="pilot-bio" maxlength="100" placeholder="Describe your mission in the stars..."></textarea>
        
        <button class="btn-primary" onclick="submitIdentity()">COMMIT TO CORE</button>
        <button id="close-modal-btn" onclick="toggleIdentityModal(false)" style="background:none; color:#555; border:none; margin-top:10px; cursor:pointer; display:none;">CANCEL CHANGES</button>
    </div>
</div>

<div class="nexus-wrapper" id="app">
    
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="pilot-search" placeholder="Search Pilots..." oninput="executePilotSearch()">
                <div id="search-results"></div>
            </div>
        </div>
        
        <div class="tab-bar">
            <div class="tab-item active" onclick="navigate('chats', this)">CHATS</div>
            <div class="tab-item" onclick="navigate('nebula', this)">NEBULA</div>
            <div class="tab-item" onclick="toggleIdentityModal(true)">PROFILE</div>
        </div>
        
        <div class="list-area" id="list-container">
            </div>
    </aside>

    <main class="main-stage" id="main-stage">
        
        <div id="chat-view" style="display:flex; flex-direction:column; height:100%;">
            <header class="stage-header">
                <div style="display:flex; align-items:center; gap:15px;">
                    <button id="back-btn" onclick="closeChatMobile()" style="display:none; background:none; border:none; color:var(--accent); font-size:1.5rem; cursor:pointer;">‚Üê</button>
                    <div class="avatar-circle" id="header-avatar">?</div>
                    <div>
                        <div id="header-name" style="font-weight:bold; color:var(--accent);">SELECT CHANNEL</div>
                        <div id="header-status" style="font-size:0.7rem; opacity:0.6;">WAITING FOR SYNC...</div>
                    </div>
                </div>
                <button onclick="handleLogout()" style="background:none; border:1px solid var(--danger); color:var(--danger); padding:5px 12px; border-radius:5px; font-size:0.7rem; cursor:pointer;">DISCONNECT</button>
            </header>
            
            <div class="message-viewport" id="message-viewport">
                </div>
            
            <footer class="input-bar">
                <label for="img-upload" class="action-icon">üìé</label>
                <input type="file" id="img-upload" style="display:none" accept="image/*" onchange="processImageUpload(this)">
                <input type="text" class="main-input" id="msg-input" placeholder="Transmit message..." onkeypress="if(event.key==='Enter') sendTransmission()">
                <div class="action-icon" onclick="sendTransmission()">‚û§</div>
            </footer>
        </div>

        <div id="nebula-view" class="nebula-container">
            <div style="background:#111b21; padding:25px; border-radius:20px; border:1px solid var(--border); margin-bottom:30px;">
                <h3 style="margin:0 0 15px 0; color:var(--accent);">GLOBAL BROADCAST</h3>
                <input type="text" id="nebula-h" placeholder="Subject">
                <textarea id="nebula-b" placeholder="Broadcast to the galaxy..." style="height:80px;"></textarea>
                <button class="btn-primary" onclick="publishToNebula()">ENGAGE TRANSMISSION</button>
            </div>
            <div id="nebula-feed-list"></div>
        </div>

    </main>
</div>

<script>
    // --- FIREBASE INITIALIZATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAxbBOThZxG5W_R1i0zVmh-TxzWOE1uDhM",
        authDomain: "cosmic-notes-f7648.firebaseapp.com",
        projectId: "cosmic-notes-f7648",
        storageBucket: "cosmic-notes-f7648.firebasestorage.app",
        messagingSenderId: "70656136344",
        appId: "1:70656136344:web:640193b83f63cac569aced"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // --- GLOBAL STATE ---
    let currentUser = null;
    let activeChatId = null;
    let msgUnsubscribe = null;
    let partnerStatusUnsubscribe = null;

    // --- AUTHENTICATION FLOW ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            validatePilotProfile();
        } else {
            showView('auth-gate');
        }
    });

    async function handleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await auth.signInWithPopup(provider);
        } catch (err) {
            alert("Connection error: " + err.message);
        }
    }

    function handleLogout() {
        setUserStatus('cloaked').then(() => {
            auth.signOut().then(() => location.reload());
        });
    }

    // --- PROFILE MANAGEMENT ---
    async function validatePilotProfile() {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists && doc.data().name) {
            showView('app');
            setUserStatus('online');
            loadConversationList();
        } else {
            toggleIdentityModal(true, false);
        }
    }

    function toggleIdentityModal(show, canClose = true) {
        const modal = document.getElementById('identity-lock');
        const closeBtn = document.getElementById('close-modal-btn');
        modal.style.display = show ? 'flex' : 'none';
        closeBtn.style.display = canClose ? 'block' : 'none';
        
        if (show && canClose) {
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                const d = doc.data();
                document.getElementById('pilot-name').value = d.name || '';
                document.getElementById('pilot-status').value = d.status || 'online';
                document.getElementById('pilot-bio').value = d.bio || '';
            });
        }
    }

    async function submitIdentity() {
        const name = document.getElementById('pilot-name').value.trim();
        const status = document.getElementById('pilot-status').value;
        const bio = document.getElementById('pilot-bio').value.trim();
        
        if (name.length < 3) return alert("Callsign must be at least 3 characters.");
        
        updateProgressBar(30);
        await db.collection('users').doc(currentUser.uid).set({
            uid: currentUser.uid,
            name: name,
            status: status,
            bio: bio,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        updateProgressBar(100);
        setTimeout(() => updateProgressBar(0), 500);
        validatePilotProfile();
    }

    // --- SEARCH LOGIC ---
    async function executePilotSearch() {
        const query = document.getElementById('pilot-search').value.toLowerCase();
        const container = document.getElementById('search-results');
        
        if (!query) { container.style.display = 'none'; return; }

        const snap = await db.collection('users')
            .where('name', '>=', query)
            .where('name', '<=', query + '\uf8ff')
            .limit(5).get();
            
        container.innerHTML = '';
        if (snap.empty) {
            container.innerHTML = '<div style="padding:15px; opacity:0.5;">No pilots found...</div>';
        } else {
            snap.forEach(doc => {
                const d = doc.data();
                if (d.uid === currentUser.uid) return;
                const div = document.createElement('div');
                div.className = 'search-item';
                div.style = "padding:12px 20px; border-bottom:1px solid #333; cursor:pointer;";
                div.innerHTML = `
                    <div style="font-weight:bold;"><span class="dot ${d.status}"></span> ${d.name}</div>
                    <div style="font-size:0.7rem; opacity:0.6;">${d.bio || 'No mission bio...'}</div>
                `;
                div.onclick = () => { establishNeuralLink(d.uid, d.name); container.style.display = 'none'; };
                container.appendChild(div);
            });
        }
        container.style.display = 'block';
    }

    // --- CHAT SYSTEM ---
    async function establishNeuralLink(targetUid, targetName) {
        const chatId = currentUser.uid < targetUid ? `${currentUser.uid}_${targetUid}` : `${targetUid}_${currentUser.uid}`;
        const myDoc = await db.collection('users').doc(currentUser.uid).get();
        
        await db.collection('chats').doc(chatId).set({
            participants: [currentUser.uid, targetUid],
            names: { [currentUser.uid]: myDoc.data().name, [targetUid]: targetName },
            lastMsg: "Secure connection established.",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        openChannel(chatId, targetName);
    }

    function openChannel(id, name) {
        if (msgUnsubscribe) msgUnsubscribe();
        if (partnerStatusUnsubscribe) partnerStatusUnsubscribe();
        
        activeChatId = id;
        if (window.innerWidth <= 800) document.getElementById('main-stage').classList.add('active');

        document.getElementById('header-name').innerText = name.toUpperCase();
        document.getElementById('header-avatar').innerText = name.charAt(0).toUpperCase();

        // Partner Status Listener
        partnerStatusUnsubscribe = db.collection('users').where('name', '==', name).onSnapshot(s => {
            if (!s.empty) {
                const d = s.docs[0].data();
                document.getElementById('header-status').innerHTML = `<span class="dot ${d.status}"></span> ${d.status.toUpperCase()}`;
            }
        });

        // Message Listener
        msgUnsubscribe = db.collection('chats').doc(id).collection('messages')
            .orderBy('ts', 'asc').onSnapshot(snap => {
                const view = document.getElementById('message-viewport');
                view.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.uid === currentUser.uid;
                    const time = d.ts ? new Date(d.ts.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
                    
                    const div = document.createElement('div');
                    div.className = `msg-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
                    div.innerHTML = `
                        ${d.image ? `<img src="${d.image}" class="msg-image" onclick="window.open('${d.image}')">` : ''}
                        <div>${d.text || ''}</div>
                        <div class="msg-info">${time} ${isMe ? '‚úì‚úì' : ''}</div>
                    `;
                    view.appendChild(div);
                });
                view.scrollTop = view.scrollHeight;
            });
    }

    async function sendTransmission() {
        const val = document.getElementById('msg-input').value.trim();
        if (!val || !activeChatId) return;
        
        document.getElementById('msg-input').value = '';
        const ts = firebase.firestore.FieldValue.serverTimestamp();
        
        await db.collection('chats').doc(activeChatId).collection('messages').add({
            text: val, uid: currentUser.uid, ts: ts
        });

        await db.collection('chats').doc(activeChatId).update({
            lastMsg: val, timestamp: ts
        });
    }

    // --- IMAGE SYSTEM ---
    async function processImageUpload(input) {
        if (!input.files || !activeChatId) return;
        const file = input.files[0];
        const path = `nexus_files/${activeChatId}/${Date.now()}_${file.name}`;
        const ref = storage.ref().child(path);
        const task = ref.put(file);

        task.on('state_changed', 
            s => { updateProgressBar((s.bytesTransferred / s.totalBytes) * 100); },
            e => { alert("Transfer Interrupted!"); },
            async () => {
                const url = await task.snapshot.ref.getDownloadURL();
                const ts = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('chats').doc(activeChatId).collection('messages').add({
                    image: url, uid: currentUser.uid, ts: ts
                });
                await db.collection('chats').doc(activeChatId).update({
                    lastMsg: "üì∑ Visual File Received", timestamp: ts
                });
                updateProgressBar(0);
                input.value = '';
            }
        );
    }

    // --- NEBULA FEED ---
    async function publishToNebula() {
        const h = document.getElementById('nebula-h').value.trim();
        const b = document.getElementById('nebula-b').value.trim();
        if (!h || !b) return alert("Broadcast fields incomplete.");

        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        await db.collection('nebula_posts').add({
            authorId: currentUser.uid,
            authorName: userDoc.data().name,
            head: h, body: b,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('nebula-h').value = '';
        document.getElementById('nebula-b').value = '';
    }

    function loadNebulaFeed() {
        db.collection('nebula_posts').orderBy('ts', 'desc').onSnapshot(snap => {
            const feed = document.getElementById('nebula-feed-list');
            feed.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const isMe = d.authorId === currentUser.uid;
                const card = document.createElement('div');
                card.className = 'nebula-post';
                card.innerHTML = `
                    <div class="post-author">PILOT: @${d.authorName}</div>
                    <div class="post-title">${d.head}</div>
                    <div class="post-body">${d.body}</div>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        ${isMe ? `<button onclick="deleteBroadcast('${doc.id}')" style="background:var(--danger); color:white; border:none; padding:6px 15px; border-radius:5px; cursor:pointer;">DESTRUCT</button>` 
                               : `<button onclick="establishNeuralLink('${d.authorId}', '${d.authorName}')" style="background:var(--accent); color:black; border:none; padding:6px 15px; border-radius:5px; cursor:pointer;">CONNECT</button>`}
                    </div>
                `;
                feed.appendChild(card);
            });
        });
    }

    async function deleteBroadcast(id) {
        if (confirm("Confirm broadcast erasure?")) await db.collection('nebula_posts').doc(id).delete();
    }

    // --- CONVERSATION LIST ---
    function loadConversationList() {
        db.collection('chats').where('participants', 'array-contains', currentUser.uid)
            .orderBy('timestamp', 'desc').onSnapshot(snap => {
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const otherId = d.participants.find(p => p !== currentUser.uid);
                    const name = d.names[otherId] || "Pilot";
                    
                    const div = document.createElement('div');
                    div.className = 'chat-row';
                    div.innerHTML = `
                        <div class="avatar-circle">${name.charAt(0).toUpperCase()}</div>
                        <div style="flex:1; overflow:hidden;">
                            <div style="font-weight:bold; color:var(--accent);">${name}</div>
                            <div style="font-size:0.75rem; opacity:0.4; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${d.lastMsg}</div>
                        </div>
                    `;
                    div.onclick = () => openChannel(doc.id, name);
                    container.appendChild(div);
                });
            });
    }

    // --- UTILITIES ---
    function showView(viewId) {
        document.getElementById('auth-gate').style.display = viewId === 'auth-gate' ? 'flex' : 'none';
        document.getElementById('app').style.display = viewId === 'app' ? 'flex' : 'none';
    }

    function navigate(view, btn) {
        document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('chat-view').style.display = view === 'chats' ? 'flex' : 'none';
        document.getElementById('nebula-view').style.display = view === 'nebula' ? 'block' : 'none';
        if (view === 'nebula') loadNebulaFeed();
    }

    function closeChatMobile() { document.getElementById('main-stage').classList.remove('active'); }
    function updateProgressBar(w) { document.getElementById('progress-bar').style.width = w + '%'; }
    async function setUserStatus(s) { if (currentUser) await db.collection('users').doc(currentUser.uid).set({ status: s }, { merge: true }); }

    // --- STAR ENGINE ---
    const canvas = document.getElementById('star-canvas'), ctx = canvas.getContext('2d');
    let stars = [];
    function initStars() { 
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
        stars = Array.from({length: 200}, () => ({ 
            x: Math.random()*canvas.width, y: Math.random()*canvas.height, 
            s: Math.random()*1.5, v: Math.random()*0.1, o: Math.random() 
        })); 
    }
    function renderStars() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        stars.forEach(s => {
            s.x += s.v; if (s.x > canvas.width) s.x = 0;
            ctx.fillStyle = `rgba(255, 255, 255, ${s.o})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(renderStars);
    }
    window.onresize = initStars; initStars(); renderStars();
</script>

</body>
</html>





