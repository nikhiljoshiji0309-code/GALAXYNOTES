// 1. Updated: Pulls actual users from your 'users' collection
async function openGroupModal() {
    toggleModal(true);
    const list = document.getElementById('contact-list');
    list.innerHTML = '<div style="padding:10px; color:var(--accent); font-size:0.8rem;">SCANNING NEBULA FOR PILOTS...</div>';
    
    try {
        const usersSnap = await db.collection('users').get();
        list.innerHTML = ''; // Clear scanner text
        
        if (usersSnap.empty) {
            list.innerHTML = '<div style="padding:10px; opacity:0.5;">No other pilots found in this sector.</div>';
            return;
        }

        usersSnap.forEach(doc => {
            // Don't show yourself in the "Add to group" list
            if(doc.id === user.uid) return;
            
            const pilot = doc.data();
            const pilotRow = document.createElement('div');
            pilotRow.style.cssText = "display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;";
            
            // Make the whole row clickable for better mobile UX
            pilotRow.onclick = (e) => {
                const cb = pilotRow.querySelector('input');
                if(e.target !== cb) cb.checked = !cb.checked;
            };

            pilotRow.innerHTML = `
                <input type="checkbox" class="user-sel" value="${doc.id}" style="width:20px; height:20px;">
                <img src="${pilot.pfp || avatars[0]}" style="width:35px; height:35px; border-radius:50%; border:1px solid #333;">
                <span style="font-size:0.9rem;">${pilot.name || 'Unknown Pilot'}</span>
            `;
            list.appendChild(pilotRow);
        });
    } catch (err) {
        console.error("Discovery Error:", err);
        list.innerHTML = '<div style="padding:10px; color:red;">Link Error: Could not reach user directory.</div>';
    }
}

// 2. Updated: Correctly launches the group with a participant array
async function createGroup() {
    const name = document.getElementById('group-name').value.trim();
    const selectedBoxes = document.querySelectorAll('.user-sel:checked');
    const selectedIDs = Array.from(selectedBoxes).map(cb => cb.value);

    if(!name) return alert("Please name this frequency (Group Name).");
    if(selectedIDs.length === 0) return alert("Select at least one pilot to join the frequency.");

    // Ensure YOU are included in the group you created
    selectedIDs.push(user.uid);

    try {
        const newGroup = await db.collection('chats').add({
            name: name,
            participants: selectedIDs,
            icon: avatars[1], // Default group icon
            lastMsg: 'Frequency established by ' + (document.getElementById('my-name').innerText),
            ts: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: user.uid
        });

        // UI Reset
        document.getElementById('group-name').value = '';
        toggleModal(false);
        alert(`Frequency ${name} Launched!`);
        
        // Automatically open the new chat
        openChat(newGroup.id, name, avatars[1]);

    } catch (err) {
        console.error("Launch Error:", err);
        alert("Failed to establish frequency.");
    }
}



