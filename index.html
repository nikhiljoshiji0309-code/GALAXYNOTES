<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Social - Galactic U</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --accent: #00d2ff; --bg: #000005; --panel: rgba(10, 10, 15, 0.98); --text: #e0e0e0; --glass: rgba(255, 255, 255, 0.05); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: var(--text); }
        
        #canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        
        /* Layout */
        .app-container { position: relative; z-index: 10; display: none; height: 100vh; width: 100vw; display: flex; }
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; pointer-events: auto; }
        .main-view { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: rgba(0,0,0,0.4); }

        /* Auth Overlay */
        #auth-overlay { position: fixed; z-index: 5000; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; text-align: center; }

        /* Navigation */
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; font-weight: 500; font-size: 0.9rem; }
        .nav-item:hover, .nav-item.active { background: rgba(0, 210, 255, 0.1); color: var(--accent); }

        /* Sections */
        .view-section { display: none; padding: 30px; height: 100%; overflow-y: auto; box-sizing: border-box; }
        .view-section.active { display: block; }

        /* Attractive UI Elements */
        .glass-card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        
        input, select, textarea { width: 100%; background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-top: 8px; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 6px; padding: 10px 20px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-danger { background: #ff4b2b; color: white; font-size: 0.7rem; padding: 5px 10px; }

        /* Profile Hub */
        .profile-display { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
        .avatar-lg { width: 90px; height: 90px; border-radius: 20px; border: 3px solid var(--accent); object-fit: cover; box-shadow: 0 0 15px var(--accent); }

        /* Chat System */
        .chat-layout { display: flex; height: 500px; background: rgba(0,0,0,0.6); border-radius: 15px; border: 1px solid #222; overflow: hidden; }
        .chat-sidebar { width: 220px; border-right: 1px solid #222; overflow-y: auto; background: rgba(0,0,0,0.2); }
        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 80%; font-size: 0.9rem; position: relative; }
        .msg-me { background: var(--accent); color: #000; align-self: flex-end; }
        .msg-them { background: #222; align-self: flex-start; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: #00ff88; box-shadow: 0 0 5px #00ff88; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="auth-overlay">
    <div>
        <h1 style="letter-spacing:12px; color:var(--accent); font-size: 2.5rem;">COSMIC</h1>
        <p style="color: #666; margin-bottom: 30px;">GALACTIC SOCIAL NETWORK</p>
        <button class="btn-primary" onclick="login()" style="padding: 15px 40px; font-size: 1rem;">SIGN IN WITH GOOGLE</button>
    </div>
</div>

<div class="app-container" id="app-ui">
    <div class="sidebar">
        <div style="padding: 30px 20px; text-align: center;">
            <img id="user-pfp" src="" style="width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover;">
            <h3 id="display-name" style="margin: 10px 0 0;">...</h3>
        </div>
        <div class="nav-item active" onclick="switchView('discover')">üî≠ DISCOVER</div>
        <div class="nav-item" onclick="switchView('new-note')">üìù NEW NOTE</div>
        <div class="nav-item" onclick="switchView('my-notes')">üìÅ MY NOTES</div>
        <div class="nav-item" onclick="switchView('chats')">üí¨ CHATS</div>
        <div class="nav-item" onclick="switchView('profile')">üë§ GALACTIC U</div>
    </div>

    <div class="main-view">
        <section id="view-discover" class="view-section active">
            <h2>Cosmic Signals</h2>
            <div id="discover-feed"></div>
        </section>

        <section id="view-new-note" class="view-section">
            <h2>Initialize Transmission</h2>
            <div class="glass-card">
                <textarea id="note-body" rows="6" placeholder="Broadcast your thoughts to the void..."></textarea>
                <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                    <select id="note-privacy" style="width:200px; margin-top:0;">
                        <option value="public">üåê PUBLIC (Everyone)</option>
                        <option value="private">üîí PRIVATE (Only Me)</option>
                    </select>
                    <button class="btn-primary" onclick="saveNote()">PUBLISH</button>
                </div>
            </div>
        </section>

        <section id="view-chats" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Communications</h2>
                <button class="btn-ghost" onclick="createGroup()">+ NEW GROUP</button>
            </div>
            <div class="chat-layout">
                <div class="chat-sidebar" id="chat-list">
                    </div>
                <div class="chat-main">
                    <div id="chat-header" style="padding:15px; border-bottom:1px solid #222; font-weight:bold;">Select Frequency</div>
                    <div id="chat-messages" class="chat-messages"></div>
                    <div style="padding:15px; border-top:1px solid #222; display:flex; gap:10px;">
                        <input id="msg-input" placeholder="Type message..." style="margin:0;">
                        <button class="btn-primary" onclick="sendMessage()">SEND</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-profile" class="view-section">
            <h2>Galactic U Identity</h2>
            <div class="glass-card">
                <div class="profile-display">
                    <img id="u-display-pfp" class="avatar-lg" src="">
                    <div>
                        <h1 id="u-display-name" style="margin:0;">Commander</h1>
                        <p id="u-display-gender" style="color:var(--accent); font-size:0.8rem; margin:5px 0;">UNSET</p>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <label>Display Name</label>
                        <input id="edit-name" type="text">
                    </div>
                    <div>
                        <label>Avatar URL</label>
                        <input id="edit-pfp" type="text">
                    </div>
                    <div>
                        <label>Gender Identity</label>
                        <select id="edit-gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <button class="btn-primary" onclick="updateProfile()" style="margin-top:25px; width:100%;">SYNC IDENTITY</button>
            </div>
        </section>

        <section id="view-my-notes" class="view-section">
            <h2>Your Archives</h2>
            <div id="personal-feed"></div>
        </section>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAxbBOThZxG5W_R1i0zVmh-TxzWOE1uDhM",
        authDomain: "cosmic-notes-f7648.firebaseapp.com",
        projectId: "cosmic-notes-f7648",
        storageBucket: "cosmic-notes-f7648.firebasestorage.app",
        messagingSenderId: "70656136344",
        appId: "1:70656136344:web:640193b83f63cac569aced"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let user = null;
    let activeChatId = null;

    // --- AUTH ---
    function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).then(async (res) => {
            user = res.user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-ui').style.display = 'flex';
            
            // Check Profile
            const uRef = db.collection('users').doc(user.uid);
            const doc = await uRef.get();
            if(!doc.exists) {
                await uRef.set({ name: user.displayName, photo: user.photoURL, gender: 'Other', status: 'online' });
            }
            loadProfile();
            loadDiscover();
            loadChatSidebar();
        });
    }

    // --- PROFILE (GALACTIC U) ---
    function loadProfile() {
        db.collection('users').doc(user.uid).onSnapshot(doc => {
            const data = doc.data();
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('user-pfp').src = data.photo;
            document.getElementById('u-display-name').innerText = data.name;
            document.getElementById('u-display-pfp').src = data.photo;
            document.getElementById('u-display-gender').innerText = data.gender.toUpperCase();
            
            document.getElementById('edit-name').value = data.name;
            document.getElementById('edit-pfp').value = data.photo;
            document.getElementById('edit-gender').value = data.gender;
        });
    }

    async function updateProfile() {
        await db.collection('users').doc(user.uid).update({
            name: document.getElementById('edit-name').value,
            photo: document.getElementById('edit-pfp').value,
            gender: document.getElementById('edit-gender').value
        });
        alert("Identity Updated.");
    }

    // --- CHATS & GROUPS ---
    function loadChatSidebar() {
        db.collection('chats').where('participants', 'array-contains', user.uid).onSnapshot(snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.style.fontSize = '0.8rem';
                div.innerHTML = `<span>${data.type === 'group' ? 'üõ∞Ô∏è' : 'üë§'}</span> ${data.name}`;
                div.onclick = () => selectChat(doc.id, data.name);
                list.appendChild(div);
            });
        });
    }

    async function createGroup() {
        const name = prompt("Group Name:");
        if(!name) return;
        await db.collection('chats').add({
            name, type: 'group', participants: [user.uid], createdAt: Date.now()
        });
    }

    function selectChat(id, name) {
        activeChatId = id;
        document.getElementById('chat-header').innerHTML = `${name} <button class="btn-danger" onclick="report()">REPORT</button>`;
        db.collection('chats').doc(id).collection('messages').orderBy('time').onSnapshot(snap => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = '';
            snap.forEach(mDoc => {
                const m = mDoc.data();
                const cls = m.sender === user.uid ? 'msg-me' : 'msg-them';
                box.innerHTML += `<div class="msg ${cls}"><strong>${m.senderName}:</strong><br>${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    async function sendMessage() {
        const text = document.getElementById('msg-input').value;
        if(!text || !activeChatId) return;
        await db.collection('chats').doc(activeChatId).collection('messages').add({
            text, sender: user.uid, senderName: document.getElementById('display-name').innerText,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msg-input').value = '';
    }

    function report() { alert("Transmission Reported to Galactic Moderators."); }

    // --- NOTES ---
    async function saveNote() {
        await db.collection('notes').add({
            content: document.getElementById('note-body').value,
            visibility: document.getElementById('note-privacy').value,
            owner: user.uid,
            ownerName: user.displayName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('note-body').value = '';
        alert("Note Synced.");
    }

    function loadDiscover() {
        db.collection('notes').where('visibility', '==', 'public').onSnapshot(snap => {
            const feed = document.getElementById('discover-feed');
            feed.innerHTML = '';
            snap.forEach(doc => {
                const n = doc.data();
                feed.innerHTML += `
                    <div class="card">
                        <h4>${n.ownerName}</h4>
                        <p>${n.content}</p>
                        <button class="btn-ghost" onclick="startPrivate('${n.owner}', '${n.ownerName}')">MESSAGE</button>
                        <button class="btn-ghost" style="border-color:#555; color:#888;">FRIEND Request</button>
                    </div>`;
            });
        });
    }

    async function startPrivate(otherId, otherName) {
        if(otherId === user.uid) return;
        const id = [user.uid, otherId].sort().join('_');
        await db.collection('chats').doc(id).set({
            name: otherName, type: 'private', participants: [user.uid, otherId]
        }, {merge:true});
        switchView('chats');
        selectChat(id, otherName);
    }

    // --- BACKGROUND ENGINE (Exactly as provided) ---
    const canvas = document.


