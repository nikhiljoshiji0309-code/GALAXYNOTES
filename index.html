<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Social - Galactic U</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --accent: #00d2ff; --bg: #000005; --panel: rgba(10, 10, 15, 0.98); --text: #e0e0e0; --glass: rgba(255, 255, 255, 0.07); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: var(--text); }
        
        #canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        
        /* Layout */
        .app-container { position: relative; z-index: 10; display: none; height: 100vh; width: 100vw; display: flex; }
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; pointer-events: auto; }
        .main-view { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: rgba(0,0,0,0.4); }

        /* Navigation */
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; font-weight: 500; font-size: 0.9rem; letter-spacing: 1px; }
        .nav-item:hover, .nav-item.active { background: rgba(0, 210, 255, 0.1); color: var(--accent); border-right: 3px solid var(--accent); }

        /* Content Areas */
        .view-section { display: none; padding: 30px; height: 100%; overflow-y: auto; box-sizing: border-box; }
        .view-section.active { display: block; }

        /* UI Elements */
        .glass-card { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; margin-bottom: 20px; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px; transition: 0.3s; }
        .card:hover { border-color: var(--accent); background: rgba(0, 210, 255, 0.03); }
        
        input, select, textarea { width: 100%; background: #0a0a0f; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-top: 5px; outline: none; }
        input:focus { border-color: var(--accent); }
        button { cursor: pointer; border: none; border-radius: 6px; padding: 10px 15px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); }
        .btn-ghost { background: transparent; border: 1px solid var(--accent); color: var(--accent); }

        /* Galactic U (Profile) */
        .profile-header { display: flex; align-items: center; gap: 30px; margin-bottom: 30px; }
        .u-avatar { width: 120px; height: 120px; border-radius: 30px; border: 3px solid var(--accent); object-fit: cover; box-shadow: 0 0 30px rgba(0, 210, 255, 0.4); }

        /* Cosmic Chat */
        .chat-ui { display: flex; height: 500px; background: rgba(0,0,0,0.6); border-radius: 15px; border: 1px solid #222; overflow: hidden; }
        .chat-list { width: 220px; border-right: 1px solid #222; overflow-y: auto; background: rgba(255,255,255,0.02); }
        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .freq-item { padding: 15px; border-bottom: 1px solid #111; cursor: pointer; font-size: 0.85rem; }
        .freq-item:hover { background: rgba(255,255,255,0.05); }
        .freq-item.active { background: rgba(0, 210, 255, 0.1); color: var(--accent); }
        .msg-bubble { margin: 8px 15px; padding: 12px 16px; border-radius: 15px; max-width: 70%; font-size: 0.9rem; }
        .me { align-self: flex-end; background: var(--accent); color: #000; }
        .them { align-self: flex-start; background: #222; color: #fff; }

        #auth-overlay { position: fixed; z-index: 5000; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="auth-overlay">
    <div>
        <h1 style="letter-spacing:15px; color:var(--accent); font-size: 3rem; margin: 0;">COSMIC</h1>
        <p style="color: #666; margin-bottom: 40px; letter-spacing: 4px;">NEURAL NETWORK</p>
        <button class="btn-primary" onclick="login()" style="padding: 18px 50px; border-radius: 50px;">INITIALIZE SESSION</button>
    </div>
</div>

<div class="app-container" id="app-ui">
    <div class="sidebar">
        <div style="padding: 40px 20px; text-align: center;">
            <img id="user-pfp" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover;">
            <h3 id="display-name" style="margin: 15px 0 0; font-weight: 300;">...</h3>
        </div>
        <div class="nav-item active" onclick="switchView('discover')">üî≠ DISCOVER</div>
        <div class="nav-item" onclick="switchView('new-note')">üìù NEW NOTE</div>
        <div class="nav-item" onclick="switchView('chats')">üí¨ COSMIC CHAT</div>
        <div class="nav-item" onclick="switchView('profile')">üë§ GALACTIC U</div>
        <div class="nav-item" onclick="switchView('my-notes')">üìÅ ARCHIVES</div>
    </div>

    <div class="main-view">
        <section id="view-discover" class="view-section active">
            <h2 style="letter-spacing: 2px;">Global Transmissions</h2>
            <div id="discover-feed"></div>
        </section>

        <section id="view-chats" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2 style="margin:0;">Frequencies</h2>
                <button class="btn-ghost" onclick="createGroup()">+ NEW GROUP</button>
            </div>
            <div class="chat-ui">
                <div class="chat-list" id="chat-sidebar-list"></div>
                <div class="chat-main">
                    <div id="chat-header" style="padding:15px; background: rgba(0,0,0,0.3); border-bottom:1px solid #222; font-weight: bold; color:var(--accent);">Select Signal</div>
                    <div id="chat-messages" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; padding-top: 15px;"></div>
                    <div style="padding:15px; background:rgba(0,0,0,0.4); display:flex; gap:10px;">
                        <input id="msg-input" placeholder="Type transmission..." style="margin:0;">
                        <button class="btn-primary" onclick="sendMessage()">SEND</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-profile" class="view-section">
            <h2 style="margin-bottom:20px;">Identity Hub</h2>
            <div class="glass-card">
                <div class="profile-header">
                    <img id="u-display-img" class="u-avatar" src="">
                    <div>
                        <h1 id="u-display-name" style="margin:0; font-size: 2rem;">Commander</h1>
                        <p id="u-display-gender" style="color:var(--accent); letter-spacing: 2px; font-size: 0.8rem; margin: 5px 0;"></p>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <label style="font-size: 0.7rem; color: #888;">COSMIC NAME</label>
                        <input id="edit-name" type="text">
                    </div>
                    <div>
                        <label style="font-size: 0.7rem; color: #888;">GENDER SIGNATURE</label>
                        <select id="edit-gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="font-size: 0.7rem; color: #888;">AVATAR TRANSPONDER URL</label>
                        <input id="edit-pfp" type="text">
                    </div>
                </div>
                <button class="btn-primary" onclick="updateProfile()" style="margin-top: 30px; width:100%; padding: 15px;">SYNC IDENTITY</button>
            </div>
        </section>

        <section id="view-new-note" class="view-section">
            <h2>Initialize Note</h2>
            <div class="glass-card">
                <textarea id="note-body" rows="8" placeholder="Log your thoughts..."></textarea>
                <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                    <select id="note-privacy" style="width: 200px; margin:0;">
                        <option value="public">üåê PUBLIC</option>
                        <option value="private">üîí PRIVATE</option>
                    </select>
                    <button class="btn-primary" onclick="saveNote()">PUBLISH</button>
                </div>
            </div>
        </section>

        <section id="view-my-notes" class="view-section">
            <h2>Personal Logs</h2>
            <div id="personal-feed"></div>
        </section>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAxbBOThZxG5W_R1i0zVmh-TxzWOE1uDhM",
        authDomain: "cosmic-notes-f7648.firebaseapp.com",
        projectId: "cosmic-notes-f7648",
        storageBucket: "cosmic-notes-f7648.firebasestorage.app",
        messagingSenderId: "70656136344",
        appId: "1:70656136344:web:640193b83f63cac569aced"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let activeChatId = null;

    function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).then(async (res) => {
            currentUser = res.user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-ui').style.display = 'flex';
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (!userDoc.exists) {
                await db.collection('users').doc(currentUser.uid).set({
                    name: currentUser.displayName,
                    photo: currentUser.photoURL,
                    gender: 'Other', status: 'online'
                });
            }
            loadProfile();
            loadDiscover();
            loadChatSidebar();
        });
    }

    // --- PROFILE (GALACTIC U) ---
    function loadProfile() {
        db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
            const d = doc.data();
            document.getElementById('display-name').innerText = d.name;
            document.getElementById('user-pfp').src = d.photo;
            document.getElementById('u-display-name').innerText = d.name;
            document.getElementById('u-display-img').src = d.photo;
            document.getElementById('u-display-gender').innerText = d.gender.toUpperCase();
            document.getElementById('edit-name').value = d.name;
            document.getElementById('edit-pfp').value = d.photo;
            document.getElementById('edit-gender').value = d.gender;
        });
    }

    async function updateProfile() {
        await db.collection('users').doc(currentUser.uid).update({
            name: document.getElementById('edit-name').value,
            photo: document.getElementById('edit-pfp').value,
            gender: document.getElementById('edit-gender').value
        });
        alert("Identity Synced with Galactic Network.");
    }

    // --- COSMIC CHAT ---
    function loadChatSidebar() {
        db.collection('chats').where('participants', 'array-contains', currentUser.uid).onSnapshot(snap => {
            const sidebar = document.getElementById('chat-sidebar-list');
            sidebar.innerHTML = '';
            snap.forEach(doc => {
                const chat = doc.data();
                const div = document.createElement('div');
                div.className = `freq-item ${activeChatId === doc.id ? 'active' : ''}`;
                div.innerHTML = `<strong>${chat.type === 'group' ? 'üõ∞Ô∏è' : 'üë§'}</strong> ${chat.chatName}`;
                div.onclick = () => selectChat(doc.id, chat.chatName);
                sidebar.appendChild(div);
            });
        });
    }

    async function createGroup() {
        const gName = prompt("Frequency Name (Group Name):");
        if(!gName) return;
        await db.collection('chats').add({
            chatName: gName, type: 'group', participants: [currentUser.uid]
        });
    }

    // FIXED: The Message Publisher helper
    async function startChat(otherId, otherName) {
        if(otherId === currentUser.uid) return;
        const id = [currentUser.uid, otherId].sort().join('_');
        
        // Switch view first for better UX
        switchView('chats');
        
        await db.collection('chats').doc(id).set({
            chatName: otherName,
            type: 'private',
            participants: [currentUser.uid, otherId]
        }, {merge: true});
        
        selectChat(id, otherName);
    }

    function selectChat(id, name) {
        activeChatId = id;
        document.getElementById('chat-header').innerText = "Signal: " + name;
        loadChatSidebar(); // Refresh active state
        
        db.collection('chats').doc(id).collection('messages').orderBy('time').onSnapshot(snap => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = '';
            snap.forEach(mDoc => {
                const m = mDoc.data();
                const cls = m.sender === currentUser.uid ? 'me' : 'them';
                box.innerHTML += `<div class="msg-bubble ${cls}"><strong>${m.senderName}:</strong><br>${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    async function sendMessage() {
        const text = document.getElementById('msg-input').value;
        if(!text || !activeChatId) return;
        await db.collection('chats').doc(activeChatId).collection('messages').add({
            text, sender: currentUser.uid, senderName: document.getElementById('display-name').innerText,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msg-input').value = '';
    }

    // --- NOTES & DISCOVER ---
    async function saveNote() {
        await db.collection('notes').add({
            content: document.getElementById('note-body').value,
            visibility: document.getElementById('note-privacy').value,
            owner: currentUser.uid,
            ownerName: document.getElementById('display-name').innerText,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('note-body').value = '';
        alert("Transmission Sent.");
    }

    function loadDiscover() {
        db.collection('notes').where('visibility', '==', 'public').onSnapshot(snap => {
            const feed = document.getElementById('discover-feed');
            feed.innerHTML = '';
            snap.forEach(doc => {
                const n = doc.data();
                const safeName = n.ownerName.replace(/'/g, "\\'"); // Fix for names with quotes
                feed.innerHTML += `
                    <div class="card">
                        <h4 style="color:var(--accent); margin:0 0 10px;">${n.ownerName}</h4>
                        <p>${n.content}</p>
                        <button class="btn-ghost" onclick="startChat('${n.owner}', '${safeName}')">Message Publisher</button>
                    </div>`;
            });
        });
    }

    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(id === 'my-notes') loadArchives();
    }

    function loadArchives() {
        db.collection('notes').where('owner', '==', currentUser.uid).onSnapshot(snap => {
            const feed = document.getElementById('personal-feed');
            feed.innerHTML = '';
            snap.forEach(d => feed.innerHTML += `<div class="card"><strong>[${d.data().visibility.toUpperCase()}]</strong><br>${d.data().content}</div>`);
        });
    }

    // --- BACKGROUND (STARS) ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let stars = [];
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    let mouse = { x: 0, y: 0 };
    let ctrlPressed = false;

    window.addEventListener('resize', initStars);
    if(!isMobile) {
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        window.addEventListener('keydown', e => { if(e.key === 'Control') ctrlPressed = true; });
        window.addEventListener('keyup', e => { if(e.key === 'Control') ctrlPressed = false; });
    }

    function initStars() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        stars = Array.from({length: 200}, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 1.5
        }));
    }

    function animate() {
        ctx.fillStyle = '#000005';
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = 'white';
        stars.forEach(s => {
            if (isMobile) {
                s.x += 0.2;
                if(s.x > canvas.width) s.x = 0;
            } else {
                let speed = ctrlPressed ? 5 : 1;
                let dx = (mouse.x - canvas.width/2) * 0.01 * speed;
                let dy = (mouse.y - canvas.height/2) * 0.01 * speed;
                s.x -= dx; s.y -= dy;
                if(s.x < 0) s.x = canvas.width; if(s.x > canvas.width) s.x = 0;
                if(s.y < 0) s.y = canvas.height; if(s.y > canvas.height) s.y = 0;
            }
            ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(animate);
    }

    initStars(); animate();
</script>
</body>
</html>




