<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Social - Universe</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --accent: #00d2ff; --bg: #000005; --glass: rgba(255, 255, 255, 0.08); --text: #f0f0f0; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Inter', sans-serif; color: var(--text); }
        #canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }

        /* Layout */
        .app-container { position: relative; z-index: 10; display: none; height: 100vh; width: 100vw; }
        .sidebar { width: 300px; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); height: 100%; position: absolute; left: 0; z-index: 20; }
        .main-view { margin-left: 300px; height: 100%; background: rgba(0,0,0,0.3); overflow-y: auto; padding: 40px; box-sizing: border-box; }

        /* Modern Navigation */
        .nav-item { padding: 18px 25px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 15px; font-weight: 500; border-radius: 0 50px 50px 0; margin-right: 10px; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: #000; box-shadow: 0 0 20px rgba(0, 210, 255, 0.4); }

        /* Glass Cards */
        .glass-card { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; margin-bottom: 20px; transition: 0.3s; }
        .glass-card:hover { border-color: var(--accent); }

        /* Enhanced Chat UI */
        .chat-container { display: flex; height: 500px; background: rgba(0,0,0,0.5); border-radius: 20px; overflow: hidden; border: 1px solid #333; }
        .chat-list { width: 250px; border-right: 1px solid #222; overflow-y: auto; background: rgba(0,0,0,0.3); }
        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .chat-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .msg-bubble { padding: 12px 18px; border-radius: 15px; max-width: 70%; margin: 5px; font-size: 0.95rem; }
        .msg-me { background: var(--accent); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-them { background: #333; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* Profile Decorations */
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .avatar-large { width: 100px; height: 100px; border-radius: 30px; border: 3px solid var(--accent); object-fit: cover; box-shadow: 0 0 25px var(--accent); }
        
        /* Auth Overlay */
        #auth-overlay { position: fixed; inset: 0; z-index: 1000; background: #000; display: flex; align-items: center; justify-content: center; }
        .btn-cosmic { background: white; color: black; border: none; padding: 15px 40px; border-radius: 50px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.3s; }
        .btn-cosmic:hover { transform: scale(1.05); box-shadow: 0 0 30px #fff; }

        input, select, textarea { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; margin-top: 8px; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="auth-overlay">
    <div style="text-align:center;">
        <h1 style="letter-spacing:15px; color:var(--accent); font-size: 3rem; margin-bottom: 0;">COSMIC</h1>
        <p style="color: #666; margin-bottom: 40px;">BEYOND THE DIGITAL HORIZON</p>
        <button class="btn-cosmic" onclick="login()">ENTER THE UNIVERSE</button>
    </div>
</div>

<div class="app-container" id="app-ui">
    <div class="sidebar">
        <div style="padding: 40px 25px;">
            <div id="sidebar-profile" style="display:flex; align-items:center; gap:12px;">
                <img id="user-pfp" src="" style="width:50px; height:50px; border-radius:15px; border:2px solid var(--accent);">
                <div>
                    <h4 id="display-name" style="margin:0;">Commander</h4>
                    <span style="font-size:0.7rem; color:#00ff88;">‚óè ONLINE</span>
                </div>
            </div>
        </div>
        <div class="nav-item active" onclick="switchView('discover')">üî≠ Discovery Feed</div>
        <div class="nav-item" onclick="switchView('new-note')">üìù Initialize Note</div>
        <div class="nav-item" onclick="switchView('chats')">üí¨ Galactic Comms</div>
        <div class="nav-item" onclick="switchView('profile')">üë§ Identity Hub</div>
    </div>

    <div class="main-view">
        <section id="view-chats" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Communications</h2>
                <button onclick="openGroupCreator()" class="btn-cosmic" style="font-size: 0.8rem; padding: 10px 20px;">+ NEW GROUP</button>
            </div>
            
            <div class="chat-container">
                <div class="chat-list" id="chat-sidebar">
                    <div style="padding:10px; font-size:0.7rem; color:#888;">FREQUENCIES</div>
                    </div>
                <div class="chat-main">
                    <div id="chat-header" style="padding:15px; border-bottom:1px solid #222; font-weight:bold;">Select a Channel</div>
                    <div id="chat-messages" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column;"></div>
                    <div style="padding:20px; display:flex; gap:10px; border-top:1px solid #222;">
                        <input id="msg-input" placeholder="Type transmission...">
                        <button onclick="sendMessage()" class="btn-cosmic" style="padding:0 25px;">SEND</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-discover">
            <h2>Cosmic Signals</h2>
            <div id="discover-feed"></div>
        </section>

        <section id="view-profile" style="display:none;">
            <div class="glass-card">
                <div class="profile-header">
                    <img id="profile-display-img" class="avatar-large" src="">
                    <div>
                        <h1 id="profile-display-name" style="margin:0;">...</h1>
                        <p id="profile-display-gender" style="color:var(--accent); text-transform:uppercase; font-size:0.8rem;"></p>
                    </div>
                </div>
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:30px 0;">
                <h3>IDENTITY SETTINGS</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <label>Visibility Name</label>
                        <input id="edit-name" type="text">
                    </div>
                    <div>
                        <label>Avatar URL</label>
                        <input id="edit-pfp" type="text">
                    </div>
                    <div>
                        <label>Gender Identity</label>
                        <select id="edit-gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other / Non-Binary</option>
                        </select>
                    </div>
                </div>
                <button onclick="updateProfile()" class="btn-cosmic" style="margin-top:30px;">SAVE IDENTITY</button>
            </div>
        </section>
        
        <section id="view-new-note" style="display:none;">
            <h2>Create Transmission</h2>
            <div class="glass-card">
                <textarea id="note-text" rows="6" placeholder="What's happening in your sector?"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                    <select id="note-vis" style="width:200px;">
                        <option value="public">üåê PUBLIC (Broadcast)</option>
                        <option value="private">üîí PRIVATE (Encrypted)</option>
                    </select>
                    <button onclick="saveNote()" class="btn-cosmic">TRANSMIT</button>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (Verified credentials) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAxbBOThZxG5W_R1i0zVmh-TxzWOE1uDhM",
        authDomain: "cosmic-notes-f7648.firebaseapp.com",
        projectId: "cosmic-notes-f7648",
        storageBucket: "cosmic-notes-f7648.firebasestorage.app",
        messagingSenderId: "70656136344",
        appId: "1:70656136344:web:640193b83f63cac569aced"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let user = null;
    let activeChat = null;

    // --- AUTHENTICATION ---
    function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).then(async (res) => {
            user = res.user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            
            // Auto-create profile if new
            const uRef = db.collection('users').doc(user.uid);
            const doc = await uRef.get();
            if(!doc.exists) {
                await uRef.set({ name: user.displayName, pfp: user.photoURL, gender: 'Other', status: 'online' });
            }
            syncProfile();
            loadDiscover();
            loadChatSidebar();
        });
    }

    // --- PROFILE ENGINE ---
    function syncProfile() {
        db.collection('users').doc(user.uid).onSnapshot(doc => {
            const data = doc.data();
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('user-pfp').src = data.pfp;
            document.getElementById('profile-display-name').innerText = data.name;
            document.getElementById('profile-display-img').src = data.pfp;
            document.getElementById('profile-display-gender').innerText = data.gender;
            
            document.getElementById('edit-name').value = data.name;
            document.getElementById('edit-pfp').value = data.pfp;
            document.getElementById('edit-gender').value = data.gender;
        });
    }

    async function updateProfile() {
        await db.collection('users').doc(user.uid).update({
            name: document.getElementById('edit-name').value,
            pfp: document.getElementById('edit-pfp').value,
            gender: document.getElementById('edit-gender').value
        });
        alert("Identity Updated.");
    }

    // --- CHAT & GROUPS ---
    function loadChatSidebar() {
        // Individual Chats & Groups listed together
        db.collection('chats').where('participants', 'array-contains', user.uid).onSnapshot(snap => {
            const list = document.getElementById('chat-sidebar');
            list.innerHTML = '';
            snap.forEach(doc => {
                const data = doc.data();
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.innerHTML = `<span>${data.type === 'group' ? 'üì°' : 'üë§'}</span> ${data.name}`;
                item.onclick = () => selectChat(doc.id, data.name);
                list.appendChild(item);
            });
        });
    }

    async function openGroupCreator() {
        const gName = prompt("Enter Group Name:");
        if(!gName) return;
        await db.collection('chats').add({
            name: gName,
            type: 'group',
            participants: [user.uid],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    function selectChat(id, name) {
        activeChat = id;
        document.getElementById('chat-header').innerText = name;
        db.collection('chats').doc(id).collection('messages').orderBy('time').onSnapshot(snap => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = '';
            snap.forEach(mDoc => {
                const m = mDoc.data();
                const align = m.sender === user.uid ? 'msg-me' : 'msg-them';
                box.innerHTML += `<div class="msg-bubble ${align}"><strong>${m.senderName}:</strong><br>${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    async function sendMessage() {
        const text = document.getElementById('msg-input').value;
        if(!text || !activeChat) return;
        await db.collection('chats').doc(activeChat).collection('messages').add({
            text, sender: user.uid, senderName: document.getElementById('display-name').innerText,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msg-input').value = '';
    }

    // --- DISCOVER FEED ---
    function loadDiscover() {
        db.collection('notes').where('vis', '==', 'public').onSnapshot(snap => {
            const feed = document.getElementById('discover-feed');
            feed.innerHTML = '';
            snap.forEach(doc => {
                const n = doc.data();
                feed.innerHTML += `
                    <div class="glass-card">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <img src="${n.ownerPfp}" style="width:30px; height:30px; border-radius:8px;">
                            <strong>${n.ownerName}</strong>
                        </div>
                        <p>${n.text}</p>
                        <button onclick="startPrivateChat('${n.ownerId}', '${n.ownerName}')" class="btn-cosmic" style="font-size:0.7rem; padding:5px 15px;">MESSAGE</button>
                    </div>`;
            });
        });
    }

    async function startPrivateChat(oId, oName) {
        if(oId === user.uid) return;
        const chatId = [user.uid, oId].sort().join('_');
        await db.collection('chats').doc(chatId).set({
            name: oName, type: 'private', participants: [user.uid, oId]
        }, {merge: true});
        switchView('chats');
        selectChat(chatId, oName);
    }

    async function saveNote() {
        await db.collection('notes').add({
            text: document.getElementById('note-text').value,
            vis: document.getElementById('note-vis').value,
            ownerId: user.uid,
            ownerName: document.getElementById('display-name').innerText,
            ownerPfp: document.getElementById('user-pfp').src,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Transmission Sent.");
        switchView('discover');
    }

    // --- NAVIGATION & BACKGROUND ---
    function switchView(id) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById('view-' + id).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    }

    // Star Engine (Mobile Drift / PC Hover)
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let stars = [], isMob = /Android|iPhone/i.test(navigator.userAgent);
    function initS() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        stars = Array.from({length: 150}, () => ({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2 }));
    }
    function anim() {
        ctx.fillStyle = '#000005'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        stars.forEach(s => {
            s.y += isMob ? 0.2 : 0; // Mobile Drift
            if(s.y > canvas.height) s.y = 0;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(anim);
    }
    initS(); anim();
</script>
</body>
</html>

