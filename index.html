<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Nexus | Sovereign Prime</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --accent: #00d2ff; --bg: #03030b; --panel: rgba(10, 10, 18, 0.96); --text: #f0f0f0; 
            --glass: rgba(255, 255, 255, 0.05); --border: rgba(0, 210, 255, 0.3);
            --danger: #ff4b2b; --heart: #ff2d55; --success: #00ff88;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; background: #000; color: var(--text); height: 100vh; overflow: hidden; }
        
        #star-canvas { position: fixed; inset: 0; z-index: 1; pointer-events: none; }
        .nexus-wrapper { position: relative; z-index: 10; display: none; height: 100vh; width: 100vw; }
        
        /* Sidebar Navigation */
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; backdrop-filter: blur(35px); transition: 0.4s; z-index: 100; }
        .nav-icons { display: flex; justify-content: space-around; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .nav-btn { cursor: pointer; opacity: 0.4; font-size: 0.65rem; letter-spacing: 2px; transition: 0.3s; color: #fff; }
        .nav-btn.active { opacity: 1; color: var(--accent); font-weight: bold; }
        .nav-btn.active::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 2px; background: var(--accent); box-shadow: 0 0 12px var(--accent); }

        /* Real-time Feedback Toast */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 12px 30px; border-radius: 50px; font-weight: 800; font-size: 0.75rem; z-index: 10000; display: none; animation: slideDown 0.4s ease; box-shadow: 0 0 20px var(--accent); }

        /* Layout Content */
        .main-content { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.3); position: relative; backdrop-filter: blur(20px); }
        .view-section { display: none; padding: 25px; height: 100%; overflow-y: auto; scroll-behavior: smooth; }
        .view-section.active { display: block; animation: viewIn 0.3s ease; }

        /* Message Logic UI */
        .message-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; }
        .sent { align-self: flex-end; }
        .received { align-self: flex-start; }
        
        .bubble { padding: 12px 18px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; }
        .sent .bubble { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .received .bubble { background: #1a1a24; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        .msg-ops { font-size: 0.6rem; color: #666; margin-bottom: 5px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        input, button { padding: 14px; border-radius: 12px; border: 1px solid #333; background: rgba(255,255,255,0.06); color: #fff; outline: none; }
        button { background: var(--accent); color: #000; font-weight: 900; border: none; cursor: pointer; }
        .btn-danger { background: rgba(255, 75, 43, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 5px 15px; font-size: 0.7rem; border-radius: 8px; }

        @keyframes viewIn { from { opacity: 0; scale: 0.98; } to { opacity: 1; scale: 1; } }
        @keyframes slideDown { from { top: -60px; } to { top: 20px; } }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; }
            .sidebar.hidden { transform: translateX(-100%); }
            .main-content { display: none; }
            .main-content.mobile-active { display: flex; width: 100%; }
        }
    </style>
</head>
<body>

<div id="toast">NEXUS STATUS: STABLE</div>
<canvas id="star-canvas"></canvas>

<div id="auth-gate" style="position:fixed; inset:0; z-index:9999; background:#03030b; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <h1 style="letter-spacing:15px; color:var(--accent); text-shadow: 0 0 15px var(--accent);">NEXUS</h1>
    <button onclick="login()" style="width:240px; border-radius:50px; margin-top:20px;">SYNC FREQUENCY</button>
</div>

<div class="nexus-wrapper" id="app">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header" style="padding:25px; border-bottom:1px solid var(--border);">
            <div style="display:flex; align-items:center; gap:15px;">
                <img id="my-pfp" src="" style="width:55px; height:55px; border-radius:50%; border:2px solid var(--accent); object-fit:cover;">
                <div>
                    <h3 id="my-name" style="margin:0; font-size:1.1rem; color:var(--accent);">Pilot</h3>
                    <div style="display:flex; align-items:center; gap:5px; font-size:0.6rem; opacity:0.6;">
                        <span style="width:6px; height:6px; background:var(--success); border-radius:50%;"></span> CONNECTED
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-icons">
            <div class="nav-btn active" onclick="showTab('chats', this)">CHATS</div>
            <div class="nav-btn" onclick="showTab('discover', this)">NEBULA</div>
            <div class="nav-btn" onclick="showTab('transmit', this)">PUBLISH</div>
            <div class="nav-btn" onclick="showTab('profile', this)">PILOT</div>
        </div>
        <div id="conversation-items" style="flex:1; overflow-y:auto;"></div>
    </aside>

    <main class="main-content" id="main-content">
        <header style="padding:18px; background:var(--panel); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;">
            <div style="display:flex; align-items:center;">
                <button onclick="closeMainView()" id="back-btn" style="display:none; width:auto; margin-right:15px; background:transparent; border:1px solid var(--accent); color:var(--accent); font-size:0.7rem; padding:5px 10px;">BACK</button>
                <div id="active-title" style="color:var(--accent); font-weight:bold; letter-spacing:2px; font-size:0.85rem;">FREQUENCY MONITOR</div>
            </div>
            <div id="chat-actions"></div>
        </header>

        <section id="tab-discover" class="view-section">
            <input type="text" id="nebula-search" placeholder="üîç Search Nebula Index..." oninput="filterNotes()" style="width:100%; margin-bottom:20px;">
            <div id="notes-feed"></div>
        </section>

        <section id="tab-transmit" class="view-section">
            <h2 style="color:var(--accent);">New Broadcast</h2>
            <input id="note-head" placeholder="Transmission Header" style="width:100%;">
            <textarea id="note-body" rows="8" placeholder="Enter transmission..." style="width:100%; background:rgba(255,255,255,0.05); color:#fff; border-radius:15px; padding:20px; margin:15px 0; border:1px solid #333; outline:none; resize:none;"></textarea>
            <button onclick="postNote()" style="width:100%; border-radius:50px;">ENGAGE BROADCAST</button>
        </section>

        <section id="tab-profile" class="view-section">
            <h2 style="color:var(--accent);">Identity Core</h2>
            <div id="avatar-picker" style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:25px;"></div>
            <input id="pilot-callsign" placeholder="Update Callsign" style="width:100%; margin-bottom:10px;">
            <button onclick="saveProfile()" style="width:100%; border-radius:50px;">RE-SYNC PROFILE</button>
            <button onclick="logout()" style="width:100%; margin-top:30px; background:var(--danger); color:#fff; border-radius:50px;">TERMINATE LINK</button>
        </section>

        <div id="active-chat-view" style="display:none; flex-direction:column; height:100%;">
            <div class="message-area" id="message-area"></div>
            <div style="padding:20px; background:var(--panel); display:flex; gap:12px; border-top:1px solid var(--border);">
                <button onclick="sendImagePrompt()" style="width:55px; background:rgba(255,255,255,0.1); border-radius:12px;">üì∏</button>
                <input id="msg-input" placeholder="Type secure message..." style="flex:1; margin:0;" onkeypress="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" style="width:90px; border-radius:12px;">SEND</button>
            </div>
        </div>
    </main>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAxbBOThZxG5W_R1i0zVmh-TxzWOE1uDhM",
        authDomain: "cosmic-notes-f7648.firebaseapp.com",
        projectId: "cosmic-notes-f7648",
        storageBucket: "cosmic-notes-f7648.firebasestorage.app",
        messagingSenderId: "70656136344",
        appId: "1:70656136344:web:640193b83f63cac569aced"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let user = null, currentChatId = null, chatUnsub = null, allNotes = [], blockedUsers = [];
    const AVATARS = [
        'https://cdn-icons-png.flaticon.com/512/2026/2026521.png',
        'https://cdn-icons-png.flaticon.com/512/2534/2534571.png',
        'https://cdn-icons-png.flaticon.com/512/9440/9440938.png',
        'https://cdn-icons-png.flaticon.com/512/2530/2530854.png'
    ];

    auth.onAuthStateChanged(u => {
        if (u) { 
            user = u; 
            document.getElementById('auth-gate').style.display='none'; 
            document.getElementById('app').style.display='flex'; 
            loadIdentity(); 
            loadSecurity();
            loadNotes(); 
            renderAvatars(); 
        } else { 
            document.getElementById('auth-gate').style.display='flex'; 
            document.getElementById('app').style.display='none'; 
        }
    });

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    function loadSecurity() {
        db.collection('users').doc(user.uid).onSnapshot(doc => {
            if(doc.exists) {
                blockedUsers = doc.data().blocked || [];
                loadChatList(); // Dynamic refresh based on block state
            }
        });
    }

    async function toggleBlock(targetUid) {
        const isBlocked = blockedUsers.includes(targetUid);
        if(confirm(`${isBlocked ? 'Restore' : 'Block'} communication with this pilot?`)) {
            const ref = db.collection('users').doc(user.uid);
            await ref.update({
                blocked: isBlocked ? firebase.firestore.FieldValue.arrayRemove(targetUid) : firebase.firestore.FieldValue.arrayUnion(targetUid)
            });
            showToast(isBlocked ? "PILOT RESTORED" : "PILOT SEVERED");
            if(!isBlocked) closeMainView();
        }
    }

    async function deleteMsg(msgId) {
        if(confirm("Expunge this transmission?")) {
            await db.collection('chats').doc(currentChatId).collection('messages').doc(msgId).delete();
            await db.collection('chats').doc(currentChatId).update({ lastMsg: "TRANSMISSION ERASED" });
            showToast("DATA EXPUNGED");
        }
    }

    function openChat(id, name, otherUid = null) {
        if(chatUnsub) chatUnsub(); // Atomic closure of previous stream
        currentChatId = id;
        
        const actions = document.getElementById('chat-actions');
        actions.innerHTML = otherUid ? `<button class="btn-danger" onclick="toggleBlock('${otherUid}')">${blockedUsers.includes(otherUid) ? 'UNBLOCK' : 'BLOCK PILOT'}</button>` : '';

        document.getElementById('active-chat-view').style.display = 'flex';
        document.getElementById('active-title').innerText = name.toUpperCase();
        
        chatUnsub = db.collection('chats').doc(id).collection('messages').orderBy('ts', 'asc').onSnapshot(snap => {
            const area = document.getElementById('message-area'); 
            area.innerHTML = '';
            snap.forEach(m => {
                const d = m.data();
                if(blockedUsers.includes(d.uid)) return; // Blocked filter

                const isMine = d.uid === user.uid;
                const content = d.isImage || (typeof d.text === 'string' && d.text.match(/\.(jpeg|jpg|gif|png|webp)$/i)) 
                    ? `<img src="${d.text}" style="max-width:100%; border-radius:12px; margin-top:10px;" onload="this.parentElement.parentElement.scrollTop = 999999">` 
                    : d.text;
                
                area.innerHTML += `
                    <div class="msg-wrapper ${isMine ? 'sent' : 'received'}">
                        ${isMine ? `<span class="msg-ops" onclick="deleteMsg('${m.id}')">Erase</span>` : ''}
                        <div class="bubble">${content}</div>
                    </div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    async function sendMsg(content = null, isImage = false) {
        const text = content || document.getElementById('msg-input').value.trim();
        if(!text || !currentChatId) return;
        document.getElementById('msg-input').value = '';
        
        await db.collection('chats').doc(currentChatId).collection('messages').add({
            text, uid: user.uid, isImage, ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('chats').doc(currentChatId).update({ 
            lastMsg: isImage ? 'üì∑ Image Broadcast' : text.substring(0, 30) + '...'
        });
    }

    function loadChatList() {
        db.collection('chats').where('participants', 'array-contains', user.uid).onSnapshot(snap => {
            const c = document.getElementById('conversation-items'); c.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const otherUid = d.participants.find(p => p !== user.uid);
                if(blockedUsers.includes(otherUid)) return; // Hide blocked chats

                const div = document.createElement('div');
                div.style = "display:flex; align-items:center; padding:18px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.03); transition:0.2s;";
                div.onclick = () => {
                    openChat(doc.id, d.name, otherUid);
                    if(window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.add('hidden');
                        document.getElementById('main-content').classList.add('mobile-active');
                        document.getElementById('back-btn').style.display='block';
                    }
                };
                div.innerHTML = `<img src="${d.icon || AVATARS[0]}" style="width:45px; height:45px; border-radius:50%; margin-right:15px; border:1.5px solid var(--border);"><div><h4 style="margin:0; font-size:0.95rem;">${d.name}</h4><p style="margin:5px 0 0; opacity:0.5; font-size:0.75rem;">${d.lastMsg || '...'}</p></div>`;
                c.appendChild(div);
            });
        });
    }

    // --- Nebula Discovery Logic ---
    function loadNotes() {
        db.collection('notes').onSnapshot(snap => {
            allNotes = []; snap.forEach(doc => allNotes.push({id: doc.id, ...doc.data()}));
            allNotes.sort((a,b) => (b.likedBy?.length || 0) - (a.likedBy?.length || 0));
            renderNotes(allNotes);
        });
    }

    function renderNotes(notes) {
        const box = document.getElementById('notes-feed'); box.innerHTML = '';
        notes.forEach(d => {
            const lb = d.likedBy || [];
            box.innerHTML += `
                <div style="background:var(--glass); padding:20px; border-radius:20px; margin-bottom:15px; border:1px solid var(--border);">
                    <h4 style="margin:0; color:var(--accent); font-size:1.1rem;">${d.head}</h4>
                    <p style="margin:15px 0; opacity:0.8; font-size:0.9rem; line-height:1.6;">${d.body}</p>
                    <div style="cursor:pointer; display:flex; align-items:center; gap:8px;" onclick="toggleLike('${d.id}')">
                        <span style="color:${lb.includes(user.uid) ? 'var(--heart)' : '#555'}; font-size:1.2rem;">‚ù§</span>
                        <span style="font-size:0.8rem; font-weight:bold; letter-spacing:1px;">${lb.length} UPVOTES</span>
                    </div>
                </div>`;
        });
    }

    async function toggleLike(id) {
        const r = db.collection('notes').doc(id);
        const d = (await r.get()).data();
        let lb = d.likedBy || [];
        lb = lb.includes(user.uid) ? lb.filter(u => u !== user.uid) : [...lb, user.uid];
        await r.update({ likedBy: lb });
    }

    async function postNote() {
        const h = document.getElementById('note-head').value, b = document.getElementById('note-body').value;
        if(!h || !b) return alert("All fields must be filled.");
        await db.collection('notes').add({ head: h, body: b, likedBy: [], ts: firebase.firestore.FieldValue.serverTimestamp() });
        document.getElementById('note-head').value=''; document.getElementById('note-body').value='';
        showToast("BROADCAST SYNCED TO NEBULA");
    }

    function showTab(t, btn) {
        if(chatUnsub) { chatUnsub(); chatUnsub = null; }
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById('active-chat-view').style.display = 'none';
        if(t !== 'chats') document.getElementById('tab-' + t).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function closeMainView() {
        document.getElementById('sidebar').classList.remove('hidden');
        document.getElementById('main-content').classList.remove('mobile-active');
    }

    function renderAvatars() {
        const g = document.getElementById('avatar-picker'); g.innerHTML = '';
        AVATARS.forEach(url => {
            const img = document.createElement('img'); img.src = url; 
            img.style = "width:100%; border-radius:50%; cursor:pointer; border:2.5px solid transparent; transition:0.3s;";
            img.onclick = () => { 
                window.selectedAvatar = url; 
                document.querySelectorAll('#avatar-picker img').forEach(i => i.style.borderColor='transparent');
                img.style.borderColor = 'var(--accent)'; 
            };
            g.appendChild(img);
        });
    }

    async function saveProfile() {
        const name = document.getElementById('pilot-callsign').value;
        if(!name) return alert("Identity callsign required.");
        await db.collection('users').doc(user.uid).set({ name, pfp: window.selectedAvatar || AVATARS[0] }, { merge: true });
        showToast("IDENTITY CORE UPDATED");
    }

    function loadIdentity() {
        db.collection('users').doc(user.uid).onSnapshot(doc => { 
            if(doc.exists) {
                document.getElementById('my-pfp').src = doc.data().pfp || AVATARS[0];
                document.getElementById('my-name').innerText = doc.data().name || 'Pilot';
            }
        });
    }

    function sendImagePrompt() {
        const url = prompt("Input Cosmic Visual URL:");
        if(url) sendMsg(url, true);
    }

    function filterNotes() {
        const q = document.getElementById('nebula-search').value.toLowerCase();
        renderNotes(allNotes.filter(n => n.head.toLowerCase().includes(q) || n.body.toLowerCase().includes(q)));
    }

    // --- Starfield Engine ---
    const canvas = document.getElementById('star-canvas'), ctx = canvas.getContext('2d');
    let stars = [];
    function initStars() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        stars = Array.from({length: 150}, () => ({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*1.5, o: Math.random() }));
    }
    function animate() {
        ctx.fillStyle = '#03030b'; ctx.fillRect(0,0,canvas.width,canvas.height);
        stars.forEach(s => {
            s.x += 0.04; if(s.x > canvas.width) s.x = 0;
            ctx.fillStyle = `rgba(255,255,255,${0.3 + Math.abs(Math.sin(Date.now()*0.001 + s.o)) * 0.7})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(animate);
    }
    window.onresize = initStars; initStars(); animate();
    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout() { auth.signOut(); }
</script>
</body>
</html>





