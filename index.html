<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Sovereign | Total Singularity</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        /* --- SUPREME DESIGN SYSTEM (LEVEL 5) --- */
        :root {
            --primary: #00d2ff;
            --primary-glow: rgba(0, 210, 255, 0.4);
            --secondary: #7000ff;
            --bg-dark: #020205;
            --surface: #0a0a12;
            --wa-green: #00a884;
            --reddit-orange: #ff4500;
            --discord-blurple: #5865f2;
            --text-main: #e0e0e0;
            --text-dim: #808080;
            --danger: #ff4b4b;
            --success: #00ff88;
            --border-spec: 1px solid rgba(255, 255, 255, 0.08);
            --glass: rgba(10, 10, 20, 0.85);
        }

        /* --- CORE RESET & ANIMATIONS --- */
        * { box-sizing: border-box; scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
        body, html { 
            margin: 0; padding: 0; background: var(--bg-dark); color: var(--text-main);
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
        }

        @keyframes nebulaPulse { 0% { opacity: 0.4; } 50% { opacity: 0.8; } 100% { opacity: 0.4; } }
        @keyframes slideInRight { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* --- SYSTEM LOADER --- */
        #master-loader {
            position: fixed; inset: 0; z-index: 9999; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .orbit-spinner {
            width: 100px; height: 100px; border: 2px solid transparent;
            border-top: 2px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; position: relative;
        }
        .orbit-spinner::before {
            content: ''; position: absolute; inset: 5px; border: 2px solid transparent;
            border-top: 2px solid var(--secondary); border-radius: 50%; animation: spin 2s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- BACKGROUND LAYER --- */
        #galaxy-engine { position: fixed; inset: 0; z-index: 0; pointer-events: none; }

        /* --- MASTER LAYOUT --- */
        .singularity-grid {
            display: none; height: 100vh; width: 100vw; position: relative; z-index: 10;
            grid-template-columns: 72px 300px 1fr 280px;
        }

        /* 1. SECTOR NAV (Discord Style) */
        .sector-nav { 
            background: #050508; border-right: var(--border-spec);
            display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 12px;
        }
        .sector-btn {
            width: 48px; height: 48px; border-radius: 50%; background: #11111a;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: 0.3s; border: 2px solid transparent; overflow: hidden;
        }
        .sector-btn:hover, .sector-btn.active { border-radius: 16px; background: var(--primary); color: #000; border-color: var(--primary-glow); }
        .divider { width: 32px; height: 2px; background: #222; border-radius: 1px; }

        /* 2. FREQUENCY LIST (WhatsApp Style) */
        .frequency-list { 
            background: #0a0a14; border-right: var(--border-spec);
            display: flex; flex-direction: column;
        }
        .list-header { padding: 24px 16px; border-bottom: var(--border-spec); }
        .search-container {
            background: #161625; border-radius: 8px; padding: 8px 12px;
            display: flex; align-items: center; border: 1px solid transparent;
        }
        .search-container:focus-within { border-color: var(--primary); }
        .search-container input { background: none; border: none; color: white; margin-left: 8px; width: 100%; outline: none; }
        
        .scroll-area { flex: 1; overflow-y: auto; scrollbar-width: none; }
        .scroll-area::-webkit-scrollbar { display: none; }
        
        .list-item {
            padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer; display: flex; gap: 12px; align-items: center;
        }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item.active { background: rgba(0, 210, 255, 0.1); border-left: 3px solid var(--primary); }

        /* 3. CORE STAGE (Reddit / Message Engine) */
        .core-stage { background: rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Message Engine Styles */
        #messenger-view { display: none; flex-direction: column; height: 100%; }
        .stage-header { height: 64px; background: var(--glass); backdrop-filter: blur(10px); border-bottom: var(--border-spec); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        .msg-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background-image: radial-gradient(#111 1px, transparent 1px); background-size: 20px 20px; }
        
        .bubble { 
            max-width: 70%; padding: 12px 16px; border-radius: 12px; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: slideInRight 0.3s ease;
            line-height: 1.5; font-size: 0.95rem;
        }
        .bubble.sent { align-self: flex-end; background: var(--wa-green); border-bottom-right-radius: 2px; }
        .bubble.received { align-self: flex-start; background: #202c33; border-bottom-left-radius: 2px; }

        /* Reddit Engine Styles */
        #reddit-view { display: flex; flex-direction: column; height: 100%; overflow-y: auto; padding: 20px; }
        .post-card {
            background: #1a1a1b; border: 1px solid #343536; border-radius: 8px;
            margin-bottom: 16px; display: flex; transition: 0.2s;
        }
        .post-card:hover { border-color: #818384; }
        .post-votes { 
            width: 48px; background: rgba(255,255,255,0.02); display: flex; flex-direction: column; 
            align-items: center; padding: 12px 0; border-radius: 8px 0 0 8px;
        }
        .post-body { padding: 16px; flex: 1; }
        .post-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 8px; color: #d7dadc; }
        
        /* 4. NEURAL ARCHIVE (Note Sharing) */
        .neural-sidebar { background: #050508; border-left: var(--border-spec); padding: 20px; display: flex; flex-direction: column; }
        .user-profile { text-align: center; margin-bottom: 30px; }
        .avatar-huge { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(45deg, var(--primary), var(--secondary)); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; color: white; border: 4px solid #111; }

        /* --- NEURAL INPUT SYSTEM --- */
        .input-anchor { padding: 20px; background: var(--glass); border-top: var(--border-spec); }
        .input-bar { 
            background: #2a3942; border-radius: 24px; display: flex; align-items: center; 
            padding: 10px 20px; gap: 12px;
        }
        .neural-content { flex: 1; background: none; border: none; color: white; outline: none; min-height: 24px; max-height: 200px; overflow-y: auto; }
        .icon-btn { cursor: pointer; opacity: 0.6; transition: 0.2s; }
        .icon-btn:hover { opacity: 1; color: var(--primary); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 5000; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--surface); padding: 40px; border-radius: 24px; border: 1px solid var(--primary);
            width: 100%; max-width: 450px; text-align: center;
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        input[type="text"], textarea, select {
            width: 100%; padding: 14px; background: #1a1a25; border: 1px solid #333;
            color: white; border-radius: 12px; margin-top: 8px;
        }
        .btn-prime {
            background: var(--primary); color: #000; border: none; padding: 16px;
            border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer;
            transition: 0.3s; letter-spacing: 1px;
        }
        .btn-prime:hover { box-shadow: 0 0 20px var(--primary-glow); transform: translateY(-2px); }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 1000px) {
            .singularity-grid { grid-template-columns: 72px 1fr; }
            .neural-sidebar, .frequency-list { display: none; }
            .frequency-list.active-mobile { display: flex; position: absolute; left: 72px; top: 0; bottom: 0; right: 0; z-index: 100; }
        }
    </style>
</head>
<body>

<div id="master-loader">
    <div class="orbit-spinner"></div>
    <h2 style="letter-spacing: 8px; margin-top: 30px; color: var(--primary);">SINGULARITY</h2>
    <p style="opacity: 0.4; font-size: 0.8rem;">INITIALIZING NEURAL LAYERS...</p>
</div>

<canvas id="galaxy-engine"></canvas>

<div id="auth-gate" class="modal-overlay" style="display: flex;">
    <div class="modal-content">
        <h1 style="color: var(--primary); letter-spacing: 12px;">NEXUS</h1>
        <p style="opacity: 0.5; margin-bottom: 30px;">SOVEREIGN OMNIPOTENCE PROTOCOL</p>
        <button class="btn-prime" onclick="initiateAuth()">INITIATE SECURE LINK</button>
        <p id="auth-feedback" style="margin-top: 15px; font-size: 0.8rem; color: var(--danger);"></p>
    </div>
</div>

<div id="identity-gate" class="modal-overlay">
    <div class="modal-content">
        <h2>IDENT_SETUP</h2>
        <div class="form-group">
            <label>PILOT CALLSIGN</label>
            <input type="text" id="setup-name" placeholder="e.g. Ghost-9">
        </div>
        <div class="form-group">
            <label>BIO TRANSMISSION</label>
            <textarea id="setup-bio" placeholder="Your mission statement..."></textarea>
        </div>
        <button class="btn-prime" onclick="finalizeIdentity()">ESTABLISH IDENTITY</button>
    </div>
</div>

<div class="singularity-grid" id="main-ui">
    
    <nav class="sector-nav">
        <div class="sector-btn active" onclick="switchMainTab('global', this)" title="Global Nebula">üåå</div>
        <div class="divider"></div>
        <div id="sovereignty-list"></div>
        <div class="sector-btn" onclick="toggleModal('create-comm')" style="color: var(--primary);">+</div>
        <div style="flex: 1;"></div>
        <div class="sector-btn" onclick="handleLogout()" title="Disconnect" style="color: var(--danger);">‚èª</div>
    </nav>

    <aside class="frequency-list">
        <div class="list-header">
            <div class="search-container">
                <span>üîç</span>
                <input type="text" id="orbital-search" placeholder="Search Neural IDs..." oninput="executeSearch()">
            </div>
            <div id="search-results" style="display:none; background: #161625; margin-top:10px; border-radius: 8px; overflow:hidden;"></div>
        </div>
        
        <div style="display: flex; border-bottom: var(--border-spec);">
            <div class="list-tab active" id="tab-posts" onclick="setListMode('posts')" style="flex:1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 2px solid var(--primary);">BROADCASTS</div>
            <div class="list-tab" id="tab-chats" onclick="setListMode('chats')" style="flex:1; padding: 15px; text-align: center; cursor: pointer; opacity: 0.5;">DIRECT</div>
        </div>

        <div class="scroll-area" id="master-list">
            </div>
    </aside>

    <main class="core-stage">
        
        <div id="reddit-view">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: var(--border-spec); margin-bottom: 24px;">
                <h3 style="margin:0 0 15px 0;">New Nebula Broadcast</h3>
                <input type="text" id="post-title" placeholder="Transmission Subject">
                <textarea id="post-body" placeholder="Broadcast content..." style="height: 100px; margin-top: 10px;"></textarea>
                <button class="btn-prime" style="margin-top: 15px;" onclick="publishBroadcast()">EMIT TO SECTOR</button>
            </div>
            <div id="broadcast-feed"></div>
        </div>

        <div id="messenger-view">
            <div class="stage-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div id="chat-avatar" class="sector-btn" style="width:36px; height:36px; background:var(--primary); color:black;">?</div>
                    <div id="chat-target-name" style="font-weight:bold;">Select a Pilot</div>
                </div>
            </div>
            <div class="msg-container" id="msg-render"></div>
            <div class="input-anchor">
                <div class="input-bar">
                    <label for="img-up" class="icon-btn">üìé</label>
                    <input type="file" id="img-up" style="display:none" onchange="uploadVisual(this)">
                    <div contenteditable="true" id="chat-input" class="neural-content" data-placeholder="Neural transmission..."></div>
                    <div class="icon-btn" onclick="sendDirectMsg()">‚û§</div>
                </div>
            </div>
        </div>
    </main>

    <section class="neural-sidebar">
        <div class="user-profile">
            <div class="avatar-huge" id="my-avatar">?</div>
            <h3 id="my-name" style="margin: 10px 0 5px;">Pilot_ID</h3>
            <p id="my-rep" style="color: var(--reddit-orange); font-size: 0.8rem; font-weight: bold;">REP: 0 CR</p>
        </div>
        
        <div style="flex: 1;">
            <h4 style="font-size: 0.7rem; color: var(--text-dim); letter-spacing: 2px;">NEURAL ARCHIVE (NOTES)</h4>
            <div id="note-list" style="margin-top: 15px;">
                </div>
        </div>
        <button class="btn-prime" style="padding: 10px; background: #111; color: var(--primary); border: 1px solid var(--primary);" onclick="createNewNote()">+ ARCHIVE DATA</button>
    </section>
</div>

<div id="create-comm" class="modal-overlay">
    <div class="modal-content">
        <h2>ESTABLISH_SECTOR</h2>
        <div class="form-group">
            <label>SECTOR NAME</label>
            <input type="text" id="comm-name" placeholder="Name of the sovereignty">
        </div>
        <div class="form-group">
            <label>PROTOCOL DESCRIPTION</label>
            <textarea id="comm-desc" placeholder="Sector mission details..."></textarea>
        </div>
        <button class="btn-prime" onclick="createSovereignty()">COMMIT SECTOR</button>
        <button onclick="toggleModal('create-comm')" style="background:none; border:none; color:gray; margin-top:15px; cursor:pointer;">CANCEL</button>
    </div>
</div>

<script>
    /* --- FIREBASE SINGULARITY CORE --- */
    const firebaseConfig = {
        apiKey: "AIzaSyAxbBOThZxG5W_R1i0zVmh-TxzWOE1uDhM",
        authDomain: "cosmic-notes-f7648.firebaseapp.com",
        projectId: "cosmic-notes-f7648",
        storageBucket: "cosmic-notes-f7648.firebasestorage.app",
        messagingSenderId: "70656136344",
        appId: "1:70656136344:web:640193b83f63cac569aced"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let pilot = null, currentDomain = 'global', listMode = 'posts', activeChatId = null;
    let unsubList = null, unsubMsgs = null;

    /* --- AUTH & IDENTITY LAYER --- */
    async function initiateAuth() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await auth.signInWithPopup(provider);
        } catch (e) {
            await auth.signInWithRedirect(provider);
        }
    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await db.collection('users').doc(user.uid).get();
            if (snap.exists && snap.data().name) {
                pilot = snap.data();
                bootSystem();
            } else {
                document.getElementById('auth-gate').style.display = 'none';
                document.getElementById('identity-gate').style.display = 'flex';
                document.getElementById('master-loader').style.display = 'none';
            }
        } else {
            document.getElementById('auth-gate').style.display = 'flex';
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('master-loader').style.display = 'none';
        }
    });

    async function finalizeIdentity() {
        const name = document.getElementById('setup-name').value.trim();
        const bio = document.getElementById('setup-bio').value.trim();
        if (name.length < 3) return alert("Callsign too short.");
        
        const newPilot = { uid: auth.currentUser.uid, name, bio, rep: 0, status: 'online', joined: firebase.firestore.FieldValue.serverTimestamp() };
        await db.collection('users').doc(auth.currentUser.uid).set(newPilot);
        pilot = newPilot;
        bootSystem();
    }

    function bootSystem() {
        document.getElementById('identity-gate').style.display = 'none';
        document.getElementById('auth-gate').style.display = 'none';
        document.getElementById('main-ui').style.display = 'grid';
        document.getElementById('master-loader').style.opacity = '0';
        setTimeout(() => document.getElementById('master-loader').style.display = 'none', 500);
        
        syncProfileUI();
        loadSovereignties();
        loadBroadcasts();
        loadNotes();
    }

    /* --- COMMUNITY (REDDIT) SYSTEM --- */
    async function createSovereignty() {
        const name = document.getElementById('comm-name').value.trim();
        const desc = document.getElementById('comm-desc').value.trim();
        if (!name) return;
        await db.collection('sovereignties').add({ name, desc, creator: pilot.uid, ts: firebase.firestore.FieldValue.serverTimestamp() });
        toggleModal('create-comm');
    }

    function loadSovereignties() {
        db.collection('sovereignties').onSnapshot(snap => {
            const list = document.getElementById('sovereignty-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const div = document.createElement('div');
                div.className = `sector-btn ${currentDomain === doc.id ? 'active' : ''}`;
                div.innerText = d.name.substring(0,2).toUpperCase();
                div.title = d.name;
                div.onclick = () => { currentDomain = doc.id; loadBroadcasts(); syncActiveSector(this); };
                list.appendChild(div);
            });
        });
    }

    async function publishBroadcast() {
        const title = document.getElementById('post-title').value.trim();
        const body = document.getElementById('post-body').value.trim();
        if (!title) return;
        await db.collection('broadcasts').add({
            title, body, author: pilot.name, authorId: pilot.uid,
            domain: currentDomain, votes: 0, ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('post-title').value = '';
        document.getElementById('post-body').value = '';
    }

    function loadBroadcasts() {
        db.collection('broadcasts').where('domain', '==', currentDomain).orderBy('ts', 'desc').onSnapshot(snap => {
            const feed = document.getElementById('broadcast-feed');
            feed.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                feed.innerHTML += `
                    <div class="post-card">
                        <div class="post-votes">
                            <span style="cursor:pointer" onclick="castVote('${doc.id}', 1)">‚ñ≤</span>
                            <span style="font-weight:bold; margin:5px 0;">${d.votes || 0}</span>
                            <span style="cursor:pointer" onclick="castVote('${doc.id}', -1)">‚ñº</span>
                        </div>
                        <div class="post-body">
                            <div style="font-size:0.7rem; color:var(--text-dim); margin-bottom:5px;">u/${d.author} ‚Ä¢ Broadcast</div>
                            <div class="post-title">${d.title}</div>
                            <div style="opacity:0.8; font-size:0.9rem;">${d.body}</div>
                        </div>
                    </div>
                `;
            });
        });
    }

    /* --- MESSAGING (WHATSAPP) SYSTEM --- */
    function openNeuralLink(chatId, partnerName) {
        if (unsubMsgs) unsubMsgs();
        activeChatId = chatId;
        document.getElementById('reddit-view').style.display = 'none';
        document.getElementById('messenger-view').style.display = 'flex';
        document.getElementById('chat-target-name').innerText = partnerName;
        document.getElementById('chat-avatar').innerText = partnerName[0];

        unsubMsgs = db.collection('chats').doc(chatId).collection('messages').orderBy('ts', 'asc').onSnapshot(snap => {
            const render = document.getElementById('msg-render');
            render.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const isMe = d.uid === pilot.uid;
                render.innerHTML += `
                    <div class="bubble ${isMe ? 'sent' : 'received'}">
                        ${d.image ? `<img src="${d.image}" style="width:100%; border-radius:8px; margin-bottom:8px;">` : ''}
                        <div>${d.text}</div>
                        <div style="font-size:0.6rem; opacity:0.4; text-align:right; margin-top:5px;">${isMe ? 'DELIVERED üó∏üó∏' : ''}</div>
                    </div>
                `;
            });
            render.scrollTop = render.scrollHeight;
        });
    }

    async function sendDirectMsg() {
        const input = document.getElementById('chat-input');
        const text = input.innerText.trim();
        if (!text || !activeChatId) return;
        input.innerText = '';
        const ts = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('chats').doc(activeChatId).collection('messages').add({ text, uid: pilot.uid, ts });
        await db.collection('chats').doc(activeChatId).update({ lastMsg: text, ts });
    }

    /* --- SEARCH & SOCIAL LAYER --- */
    async function executeSearch() {
        const q = document.getElementById('orbital-search').value.toLowerCase();
        const res = document.getElementById('search-results');
        if (!q) { res.style.display = 'none'; return; }
        
        const snap = await db.collection('users').where('name', '>=', q).where('name', '<=', q + '\uf8ff').limit(5).get();
        res.innerHTML = '';
        snap.forEach(doc => {
            const d = doc.data(); if(d.uid === pilot.uid) return;
            const div = document.createElement('div');
            div.style = "padding:12px; border-bottom:1px solid #222; cursor:pointer;";
            div.innerText = d.name;
            div.onclick = () => createChat(d.uid, d.name);
            res.appendChild(div);
        });
        res.style.display = 'block';
    }

    async function createChat(tId, tName) {
        const cId = pilot.uid < tId ? `${pilot.uid}_${tId}` : `${tId}_${pilot.uid}`;
        await db.collection('chats').doc(cId).set({
            participants: [pilot.uid, tId],
            names: {[pilot.uid]: pilot.name, [tId]: tName},
            lastMsg: 'Encrypted link established',
            ts: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        document.getElementById('search-results').style.display = 'none';
        setListMode('chats');
        openNeuralLink(cId, tName);
    }

    /* --- NOTE ARCHIVE SYSTEM --- */
    async function createNewNote() {
        const content = prompt("Enter data to archive:");
        if (!content) return;
        await db.collection('users').doc(pilot.uid).collection('notes').add({
            content, ts: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    function loadNotes() {
        db.collection('users').doc(pilot.uid).collection('notes').orderBy('ts', 'desc').onSnapshot(snap => {
            const list = document.getElementById('note-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `<div style="background:#111; padding:10px; border-radius:8px; margin-bottom:10px; font-size:0.8rem; border-left:2px solid var(--secondary);">
                    ${d.content}
                </div>`;
            });
        });
    }

    /* --- UI UTILITIES --- */
    function syncProfileUI() {
        document.getElementById('my-name').innerText = pilot.name;
        document.getElementById('my-avatar').innerText = pilot.name[0];
        document.getElementById('my-rep').innerText = `REP: ${pilot.rep || 0} CR`;
    }

    function switchMainTab(domain, btn) {
        currentDomain = domain;
        document.querySelectorAll('.sector-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('messenger-view').style.display = 'none';
        document.getElementById('reddit-view').style.display = 'flex';
        loadBroadcasts();
    }

    function setListMode(mode) {
        listMode = mode;
        document.querySelectorAll('.list-tab').forEach(t => t.style.opacity = '0.5');
        document.getElementById(`tab-${mode}`).style.opacity = '1';
        if (mode === 'chats') loadChatThreads(); else loadBroadcasts();
    }

    function loadChatThreads() {
        db.collection('chats').where('participants', 'array-contains', pilot.uid).orderBy('ts', 'desc').onSnapshot(snap => {
            const list = document.getElementById('master-list');
            if (listMode !== 'chats') return;
            list.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const oId = d.participants.find(p => p !== pilot.uid);
                list.innerHTML += `<div class="list-item" onclick="openNeuralLink('${doc.id}', '${d.names[oId]}')">
                    <div class="sector-btn" style="width:40px; height:40px; background:#222;">${d.names[oId][0]}</div>
                    <div style="flex:1">
                        <div style="font-weight:bold;">${d.names[oId]}</div>
                        <div style="font-size:0.7rem; opacity:0.4;">${d.lastMsg}</div>
                    </div>
                </div>`;
            });
        });
    }

    async function castVote(id, val) {
        const ref = db.collection('broadcasts').doc(id);
        await db.runTransaction(async (t) => {
            const doc = await t.get(ref);
            const newVotes = (doc.data().votes || 0) + val;
            t.update(ref, { votes: newVotes });
        });
    }

    function toggleModal(id) {
        const m = document.getElementById(id);
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }

    function handleLogout() { auth.signOut().then(() => location.reload()); }

    /* --- STARFIELD ENGINE (CORE) --- */
    const canvas = document.getElementById('galaxy-engine'), ctx = canvas.getContext('2d');
    let stars = [];
    function init() { 
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
        stars = Array.from({length: 300}, () => ({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*1.5, v: Math.random()*0.15 })); 
    }
    function draw() {
        ctx.fillStyle = '#020205'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#fff';
        stars.forEach(s => { 
            s.x += s.v; if(s.x > canvas.width) s.x = 0;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill(); 
        });
        requestAnimationFrame(draw);
    }
    window.onresize = init; init(); draw();
</script>
</body>
</html>






