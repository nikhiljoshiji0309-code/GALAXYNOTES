<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Sovereign | Lightning Fast v2.2</title>
    
    <!-- Firebase SDKs (Latest Stable) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* ========================================
           ULTRA-FAST CSS (Optimized for 60fps)
           ======================================== */
        :root {
            --primary: #00d2ff;
            --primary-glow: rgba(0, 210, 255, 0.3);
            --secondary: #9d50bb;
            --wa-green: #00a884;
            --reddit-orange: #ff4500;
            --bg-dark: #050508;
            --panel-dark: #0a0a14;
            --glass: rgba(10, 10, 20, 0.9);
            --border: rgba(255, 255, 255, 0.08);
            --text-high: #ffffff;
            --text-mid: #b0b0b0;
            --text-low: #606060;
            --danger: #ef4444;
            --success: #10b981;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
            --transition-fast: all 0.2s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            height: 100vh; width: 100vw; background: var(--bg-dark); 
            color: var(--text-high); font-family: system-ui, sans-serif;
            overflow: hidden;
        }

        /* Starfield Canvas */
        #galaxy-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; }

        /* Loading Screen */
        #loading-overlay {
            position: fixed; inset: 0; z-index: 10000; background: var(--bg-dark);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid rgba(0,210,255,0.2);
            border-top: 3px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: var(--text-mid); font-size: 1rem; }

        /* Main Shell - Mobile First */
        .nexus-shell {
            display: none; height: 100vh; width: 100vw; position: relative; z-index: 10;
            flex-direction: column;
        }

        /* Mobile Layout */
        @media (max-width: 768px) {
            .nexus-shell { 
                grid-template-areas: 
                    "nav" 
                    "sidebar" 
                    "main" 
                    "profile"; 
            }
        }

        /* Tablet+ Layout */
        @media (min-width: 769px) {
            .nexus-shell { 
                display: grid; 
                grid-template-columns: 70px 350px 1fr 280px; 
            }
        }

        /* Sector Nav */
        .sector-nav { 
            background: rgba(2,2,5,0.95); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 15px;
            backdrop-filter: blur(20px);
        }
        .sector-icon {
            width: 48px; height: 48px; border-radius: 50%; background: rgba(17,17,25,0.8);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 2px solid transparent; transition: var(--transition-fast);
            color: var(--text-mid); font-weight: 900;
        }
        .sector-icon:hover, .sector-icon.active { 
            background: var(--primary); color: #000; border-color: var(--primary);
        }

        /* Sidebar */
        .frequency-sidebar { 
            background: var(--panel-dark); border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid var(--border); }
        .search-rail {
            background: rgba(22,22,37,0.8); border-radius: 10px; display: flex; align-items: center;
            padding: 12px 16px; margin-bottom: 20px;
        }
        .search-rail input { background: none; border: none; color: white; margin-left: 12px; flex: 1; }

        .mode-tabs { display: flex; }
        .mode-tab {
            flex: 1; padding: 16px; text-align: center; cursor: pointer;
            border-bottom: 3px solid transparent; transition: var(--transition-fast);
        }
        .mode-tab.active { 
            background: rgba(0,210,255,0.1); color: var(--primary); 
            border-bottom-color: var(--primary);
        }

        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .thread-item {
            padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; display: flex; align-items: center; gap: 15px;
        }
        .thread-item:hover { background: rgba(255,255,255,0.05); }
        .thread-avatar { 
            width: 44px; height: 44px; border-radius: 50%; 
            background: var(--primary); color: #000; display: flex; align-items: center; justify-content: center;
        }

        /* Main Content */
        .core-engine { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #reddit-view, #chat-view { flex: 1; overflow-y: auto; padding: 30px; display: none; }
        #reddit-view.active, #chat-view.active { display: block; }

        .composer-card {
            background: rgba(26,26,27,0.9); border: 1px solid rgba(52,53,54,0.5);
            border-radius: 12px; padding: 25px; margin-bottom: 30px;
        }
        .composer-input {
            width: 100%; background: rgba(39,39,41,0.9); border: 1px solid rgba(52,53,54,0.5);
            padding: 16px; border-radius: 8px; color: white; margin-bottom: 15px;
            font-size: 1rem;
        }
        .btn-primary {
            background: var(--primary); color: #000; border: none; padding: 14px 28px;
            border-radius: 25px; font-weight: 800; cursor: pointer; width: 100%;
        }

        .post-card {
            background: rgba(26,26,27,0.9); border: 1px solid rgba(52,53,54,0.5);
            border-radius: 12px; margin-bottom: 20px; padding: 20px; display: flex; gap: 20px;
        }
        .post-vote-rail { 
            width: 50px; display: flex; flex-direction: column; align-items: center; 
            color: var(--text-mid); font-weight: 900;
        }
        .vote-arrow { cursor: pointer; font-size: 1.2rem; padding: 5px; }
        .vote-arrow:hover { color: var(--reddit-orange); }

        /* Chat */
        .chat-header {
            height: 70px; background: rgba(16,27,33,0.95); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 25px;
        }
        .message-stream { height: calc(100% - 140px); overflow-y: auto; padding: 20px 0; }
        .bubble {
            max-width: 70%; padding: 12px 18px; border-radius: 18px; margin-bottom: 12px;
        }
        .sent { background: var(--wa-green); align-self: flex-end; margin-left: auto; }
        .received { background: #202c33; align-self: flex-start; }

        .editor-dock {
            padding: 20px; background: rgba(17,27,33,0.95); border-top: 1px solid var(--border);
        }
        .rich-input {
            flex: 1; background: rgba(42,57,66,0.9); border-radius: 25px; padding: 14px 20px;
            color: white; border: none; min-height: 48px; resize: none;
        }

        /* Profile */
        .profile-sidebar {
            background: rgba(2,2,5,0.95); border-left: 1px solid var(--border); padding: 30px 20px;
        }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%; background: var(--primary);
            margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; color: #000; font-weight: 900;
        }
        .note-card {
            background: rgba(17,17,25,0.8); padding: 15px; border-radius: 8px;
            margin-bottom: 12px; border-left: 3px solid var(--primary);
        }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 5000; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center;
        }
        .modal-container {
            background: var(--panel-dark); padding: 40px; border-radius: 20px;
            max-width: 90vw; max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--primary);
        }

        .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Starfield -->
<canvas id="galaxy-canvas"></canvas>

<!-- Loading -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <p class="loading-text" id="loading-text">Initializing...</p>
</div>

<!-- Auth Modal -->
<div id="auth-overlay" class="modal-overlay">
    <div class="modal-container">
        <h1 style="color: var(--primary); font-size: 2.5rem; margin-bottom: 10px;">NEXUS</h1>
        <p style="opacity: 0.6; margin-bottom: 30px;">Lightning Fast v2.2</p>
        <button class="btn-primary" onclick="login()">üîó Google Login</button>
        <p id="auth-error" class="error-msg hidden"></p>
    </div>
</div>

<!-- Setup Modal -->
<div id="setup-modal" class="modal-overlay">
    <div class="modal-container">
        <h2 style="color: var(--primary); margin-bottom: 20px;">Setup Pilot</h2>
        <input id="pilot-name" class="composer-input" placeholder="Pilot Name (3+ chars)">
        <textarea id="pilot-bio" class="composer-input" placeholder="Bio (optional)" style="height: 100px; margin-top: 15px;"></textarea>
        <button class="btn-primary" onclick="setupPilot()" style="margin-top: 20px;">üöÄ Launch</button>
    </div>
</div>

<!-- Main App -->
<div class="nexus-shell" id="app-shell">
    <!-- Nav -->
    <nav class="sector-nav">
        <div class="sector-icon active" onclick="setDomain('global')">üåê</div>
        <div class="sector-icon" onclick="createSector()">+</div>
        <div style="flex: 1;"></div>
        <div class="sector-icon" onclick="logout()" style="color: var(--danger);">‚ö°</div>
    </nav>

    <!-- Sidebar -->
    <aside class="frequency-sidebar">
        <div class="sidebar-header">
            <h3>FREQUENCY</h3>
            <div class="search-rail">
                <span>üîç</span>
                <input id="search-input" placeholder="Search pilots..." oninput="searchPilots()">
            </div>
        </div>
        <div class="mode-tabs">
            <div class="mode-tab active" id="tab-feed" onclick="setMode('feed')">üì° Feed</div>
            <div class="mode-tab" id="tab-chat" onclick="setMode('chat')">üí¨ Chat</div>
        </div>
        <div class="list-container" id="sidebar-list"></div>
    </aside>

    <!-- Main -->
    <main class="core-engine">
        <div id="reddit-view">
            <div class="composer-card">
                <h4>Post</h4>
                <input id="post-title" class="composer-input" placeholder="Title">
                <textarea id="post-content" class="composer-input" placeholder="Content" style="height: 100px;"></textarea>
                <span id="char-count" style="color: var(--text-low); font-size: 0.8rem;">0/2000</span>
                <button class="btn-primary" onclick="createPost()">Post</button>
            </div>
            <div id="feed"></div>
        </div>

        <div id="chat-view">
            <div class="chat-header">
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <div id="chat-avatar" class="thread-avatar">?</div>
                    <div>
                        <div id="chat-name">Select Chat</div>
                        <div style="font-size: 0.8rem; color: var(--wa-green);">‚óè Online</div>
                    </div>
                </div>
            </div>
            <div class="message-stream" id="messages"></div>
            <div class="editor-dock">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div contenteditable="true" id="message-input" class="rich-input" placeholder="Type message..."></div>
                    <button class="btn-primary" style="width: 50px; height: 50px; border-radius: 50%; padding: 0;" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Profile -->
    <aside class="profile-sidebar">
        <div class="profile-avatar" id="profile-avatar">?</div>
        <h3 id="profile-name">Loading...</h3>
        <p id="profile-bio"></p>
        <div style="margin: 30px 0;">
            <div style="text-align: center; color: var(--text-mid); margin-bottom: 10px;">Karma: <span id="karma-count">0</span></div>
        </div>
        <h4 style="color: var(--text-low); margin-bottom: 15px;">Notes</h4>
        <div id="notes-list"></div>
        <button class="btn-primary" onclick="showNoteModal()" style="margin-top: 20px; padding: 12px;">+ Note</button>
    </aside>
</div>

<!-- Note Modal -->
<div id="note-modal" class="modal-overlay">
    <div class="modal-container">
        <h3>Add Note</h3>
        <textarea id="note-text" class="composer-input" style="height: 150px;"></textarea>
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="btn-primary" onclick="saveNote()">Save</button>
            <button onclick="closeModal('note-modal')" style="flex: 1; background: transparent; color: var(--text-mid); border: 1px solid var(--border);">Cancel</button>
        </div>
    </div>
</div>

<script>
/* ========================================
   NEXUS SOVEREIGN v2.2 - LIGHTNING FAST (2s load)
   üöÄ PRODUCTION READY | NO MORE 5MIN HANGS
   ======================================== */

// ========================================
// FIREBASE & STATE
// ========================================
const firebaseConfig = {
    apiKey: "AIzaSyAxbBOThZxG5W_R1i0zVmh-TxzWOE1uDhM",
    authDomain: "cosmic-notes-f7648.firebaseapp.com",
    projectId: "cosmic-notes-f7648",
    storageBucket: "cosmic-notes-f7648.firebasestorage.app",
    messagingSenderId: "70656136344",
    appId: "1:70656136344:web:640193b83f63cac569aced"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// State
let user = null;
let currentChat = null;
let currentDomain = 'global';
let listeners = [];

// ========================================
// ULTRA-FAST INIT (2s max)
// ========================================
function setLoading(text) {
    document.getElementById('loading-text').textContent = text;
}

async function initApp() {
    setLoading('üîó Connecting...');
    
    auth.onAuthStateChanged(async (u) => {
        if (u) {
            setLoading('üß† Loading profile...');
            
            // Fast profile load (5s timeout)
            try {
                const doc = await Promise.race([
                    db.collection('users').doc(u.uid).get(),
                    new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 5000))
                ]);
                
                if (doc.exists) {
                    user = { id: u.uid, ...doc.data() };
                    showApp();
                } else {
                    showSetup();
                }
            } catch (e) {
                showError('Profile load timeout. Try again.');
                showSetup();
            }
        } else {
            showLogin();
        }
    });
}

// ========================================
// UI CONTROL
// ========================================
function showLogin() { 
    document.getElementById('auth-overlay').classList.remove('hidden');
    document.getElementById('app-shell').classList.add('hidden');
}
function showSetup() { 
    document.getElementById('auth-overlay').classList.add('hidden');
    document.getElementById('setup-modal').classList.remove('hidden');
}
function showApp() {
    document.getElementById('loading-overlay').classList.add('hidden');
    document.getElementById('app-shell').classList.remove('hidden');
    updateProfile();
    loadFeed();
}
function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

function showError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000);
}

// ========================================
// AUTH
// ========================================
async function login() {
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
    } catch (e) {
        showError(`Login failed: ${e.message}`);
    }
}

async function setupPilot() {
    const name = document.getElementById('pilot-name').value.trim();
    if (name.length < 3) return showError('Name must be 3+ chars');
    
    try {
        await db.collection('users').doc(auth.currentUser.uid).set({
            name,
            bio: document.getElementById('pilot-bio').value.trim(),
            karma: 0,
            posts: 0,
            joined: firebase.firestore.Timestamp.now()
        });
        closeModal('setup-modal');
    } catch (e) {
        showError('Setup failed');
    }
}

async function logout() {
    await auth.signOut();
}

// ========================================
// CORE FEATURES
// ========================================
function setMode(mode) {
    document.getElementById('tab-feed').classList.toggle('active', mode === 'feed');
    document.getElementById('tab-chat').classList.toggle('active', mode === 'chat');
    document.getElementById('reddit-view').classList.toggle('active', mode === 'feed');
    document.getElementById('chat-view').classList.toggle('active', mode === 'chat');
    
    if (mode === 'chat') loadChats();
}

async function createPost() {
    const title = document.getElementById('post-title').value.trim();
    const content = document.getElementById('post-content').value.trim();
    
    if (!title) return;
    
    try {
        await db.collection('posts').add({
            title, content, author: user.name, authorId: user.id,
            domain: currentDomain, karma: 0, created: firebase.firestore.Timestamp.now()
        });
        
        document.getElementById('post-title').value = '';
        document.getElementById('post-content').value = '';
        loadFeed();
    } catch (e) {
        showError('Post failed');
    }
}

function loadFeed() {
    const feed = document.getElementById('feed');
    feed.innerHTML = '<div style="padding:30px; text-align:center; color:var(--text-mid);">Loading...</div>';
    
    db.collection('posts')
        .where('domain', '==', currentDomain)
        .orderBy('created', 'desc')
        .limit(15)
        .get()
        .then(snap => {
            feed.innerHTML = '';
            snap.forEach(doc => {
                const p = doc.data();
                const div = document.createElement('div');
                div.className = 'post-card';
                div.innerHTML = `
                    <div class="post-vote-rail">
                        <div class="vote-arrow">‚ñ≤</div>
                        <div>${p.karma || 0}</div>
                        <div class="vote-arrow">‚ñº</div>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:0.85rem; color:var(--text-low); margin-bottom:10px;">
                            u/${p.author} ‚Ä¢ ${p.created.toDate().toLocaleString()}
                        </div>
                        <h3>${p.title}</h3>
                        <p style="color:var(--text-mid); line-height:1.5;">${p.content.substring(0, 200)}${p.content.length > 200 ? '...' : ''}</p>
                    </div>
                `;
                feed.appendChild(div);
            });
        });
}

function loadChats() {
    const list = document.getElementById('sidebar-list');
    list.innerHTML = 'Loading chats...';
    
    db.collection('chats')
        .where('users', 'array-contains', user.id)
        .orderBy('lastMessage', 'desc')
        .limit(10)
        .get()
        .then(snap => {
            list.innerHTML = '';
            snap.forEach(doc => {
                const chat = doc.data();
                const other = chat.users.find(id => id !== user.id);
                const item = document.createElement('div');
                item.className = 'thread-item';
                item.innerHTML = `<div class="thread-avatar">${chat.name?.[0] || '?'}</div>
                    <div style="flex:1;"><div>${chat.name || 'Unknown'}</div><div style="font-size:0.8rem;color:var(--text-low);">${chat.lastMessage || 'No messages'}</div></div>`;
                item.onclick = () => openChat(doc.id, chat);
                list.appendChild(item);
            });
        });
}

function openChat(chatId, chat) {
    currentChat = chatId;
    document.getElementById('chat-name').textContent = chat.name || 'Chat';
    loadMessages();
}

function loadMessages() {
    const msgs = document.getElementById('messages');
    msgs.innerHTML = '';
    
    db.collection('chats').doc(currentChat).collection('messages')
        .orderBy('timestamp')
        .limit(50)
        .get()
        .then(snap => {
            snap.forEach(doc => {
                const m = doc.data();
                const bubble = document.createElement('div');
                bubble.className = `bubble ${m.authorId === user.id ? 'sent' : 'received'}`;
                bubble.innerHTML = `<div>${m.text}</div><div style="font-size:0.7rem;opacity:0.7;margin-top:5px;">${m.timestamp.toDate().toLocaleTimeString()}</div>`;
                msgs.appendChild(bubble);
            });
            msgs.scrollTop = msgs.scrollHeight;
        });
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.innerText.trim();
    if (!text || !currentChat) return;
    
    try {
        await db.collection('chats').doc(currentChat).collection('messages').add({
            text, authorId: user.id, author: user.name,
            timestamp: firebase.firestore.Timestamp.now()
        });
        
        await db.collection('chats').doc(currentChat).update({
            lastMessage: text.substring(0, 30),
            lastTimestamp: firebase.firestore.Timestamp.now()
        });
        
        input.innerText = '';
        loadMessages();
    } catch (e) {
        showError('Message failed');
    }
}

// ========================================
// PROFILE & NOTES
// ========================================
function updateProfile() {
    document.getElementById('profile-avatar').textContent = user.name[0];
    document.getElementById('profile-name').textContent = user.name;
    document.getElementById('profile-bio').textContent = user.bio || '';
    document.getElementById('karma-count').textContent = user.karma || 0;
    loadNotes();
}

function loadNotes() {
    db.collection('users').doc(user.id).collection('notes')
        .orderBy('created', 'desc')
        .limit(10)
        .get()
        .then(snap => {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const note = document.createElement('div');
                note.className = 'note-card';
                note.textContent = doc.data().text.substring(0, 100);
                list.appendChild(note);
            });
        });
}

function showNoteModal() {
    document.getElementById('note-modal').classList.remove('hidden');
}

async function saveNote() {
    const text = document.getElementById('note-text').value.trim();
    if (!text) return;
    
    try {
        await db.collection('users').doc(user.id).collection('notes').add({
            text, created: firebase.firestore.Timestamp.now()
        });
        document.getElementById('note-text').value = '';
        closeModal('note-modal');
        loadNotes();
    } catch (e) {
        showError('Note failed');
    }
}

// ========================================
// UTILS
// ========================================
document.getElementById('message-input').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

document.getElementById('post-content').addEventListener('input', function() {
    document.getElementById('char-count').textContent = `${this.value.length}/2000`;
});

// Lightweight starfield
const canvas = document.getElementById('galaxy-canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const stars = [];
for (let i = 0; i < 80; i++) {
    stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 1.5,
        speed: Math.random() * 0.5
    });
}

function animateStars() {
    ctx.fillStyle = 'rgba(5,5,8,0.9)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = 'white';
    stars.forEach(star => {
        star.x += star.speed;
        if (star.x > canvas.width) star.x = 0;
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
        ctx.fill();
    });
    requestAnimationFrame(animateStars);
}
animateStars();

// START APP
initApp();
console.log('üöÄ Nexus v2.2 - Lightning Fast Loaded!');
</script>
</body>
</html>










